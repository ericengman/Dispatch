---
phase: 12-verification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "When Dispatch is not running, dispatch_init returns a fallback temp path"
    - "Fallback message is clear and tells user where screenshots are saved"
    - "Skills continue functioning correctly without Dispatch"
    - "dispatch_finalize outputs clear message about where screenshots remain"
  artifacts:
    - path: ".planning/phases/12-verification/12-02-FALLBACK-RESULTS.md"
      provides: "Fallback behavior test results"
      contains: "Dispatch not running"
  key_links:
    - from: "dispatch_init"
      to: "/tmp/screenshots-*"
      via: "fallback path creation"
      pattern: "mkdir -p.*fallback_path"
    - from: "dispatch_finalize"
      to: "stderr"
      via: "fallback message"
      pattern: "screenshots remain in"
---

<objective>
Test graceful degradation when Dispatch app is not running

Purpose: Verify that skills work correctly even when Dispatch is unavailable, providing a clear fallback experience with helpful messaging. This ensures the integration is non-blocking and skills can always complete their work.

Output: Documented fallback test results proving graceful degradation works.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@~/.claude/lib/dispatch.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test Library Fallback Behavior</name>
  <files>.planning/phases/12-verification/12-02-FALLBACK-RESULTS.md</files>
  <action>
Test the dispatch.sh library directly with Dispatch app stopped.

**Step 1: Stop Dispatch if running**
```bash
pkill -x "Dispatch" 2>/dev/null || true
sleep 2
```

**Step 2: Verify Dispatch is not running**
```bash
curl -s http://localhost:19847/health 2>/dev/null || echo "Dispatch not responding (expected)"
```

**Step 3: Test dispatch_init fallback**
```bash
# Source the library
source ~/.claude/lib/dispatch.sh

# Call init - should detect Dispatch is not running and use fallback
dispatch_init "Fallback Test" "Test Device"

# Check what was returned
echo "DISPATCH_AVAILABLE: ${DISPATCH_AVAILABLE:-unset}"
echo "DISPATCH_SCREENSHOT_PATH: ${DISPATCH_SCREENSHOT_PATH:-unset}"
echo "DISPATCH_STATE_FILE: ${DISPATCH_STATE_FILE:-unset}"
```

**Expected output (to stderr):**
```
Dispatch not running - screenshots saved to: /tmp/screenshots-[timestamp]
```

**Step 4: Verify fallback directory was created**
```bash
# Source state file to get variables
source "$DISPATCH_STATE_FILE"

# Check if directory exists
ls -la "$DISPATCH_SCREENSHOT_PATH"
```

**Step 5: Test dispatch_finalize fallback message**
```bash
dispatch_finalize
```

**Expected output (to stderr):**
```
Dispatch was not running - screenshots remain in: /tmp/screenshots-[timestamp]
```

**Step 6: Document results**
Create `.planning/phases/12-verification/12-02-FALLBACK-RESULTS.md` with:
- Health check result (should fail)
- dispatch_init output (fallback message)
- DISPATCH_AVAILABLE value (should be "false")
- DISPATCH_SCREENSHOT_PATH value (should be /tmp/screenshots-*)
- Directory creation verified (Y/N)
- dispatch_finalize output (fallback message)
- Overall: PASS/FAIL

**Step 7: Restart Dispatch**
```bash
open -a Dispatch
```
  </action>
  <verify>
- dispatch_init returns exit code 1 (indicates fallback used) but doesn't fail fatally
- DISPATCH_AVAILABLE is "false"
- DISPATCH_SCREENSHOT_PATH points to /tmp/screenshots-[timestamp]
- Fallback directory exists and is writable
- Fallback messages are clear and helpful
- dispatch_finalize completes without error
  </verify>
  <done>Graceful degradation verified - skills work without Dispatch with clear messaging</done>
</task>

<task type="auto">
  <name>Task 2: Test Skill Execution Without Dispatch</name>
  <files>.planning/phases/12-verification/12-02-FALLBACK-RESULTS.md</files>
  <action>
Verify that a real skill works correctly with Dispatch stopped.

**Note:** This test requires an iOS project. If none available, document that and skip to conclusion.

**Step 1: Stop Dispatch**
```bash
pkill -x "Dispatch" 2>/dev/null || true
sleep 2
```

**Step 2: Execute a skill (test-feature is simplest)**
Run the skill and observe:
- Does it start successfully?
- Does it output the fallback message?
- Does it complete its work (take screenshots)?
- Does it output the finalize message?

**Step 3: Verify screenshots in fallback location**
```bash
# Find the most recent fallback directory
ls -lt /tmp/screenshots-* | head -5

# Check contents of most recent
FALLBACK_DIR=$(ls -td /tmp/screenshots-* | head -1)
ls -la "$FALLBACK_DIR"
```

**Step 4: Update results document**
Add to `.planning/phases/12-verification/12-02-FALLBACK-RESULTS.md`:
- Skill tested
- Fallback message observed (Y/N)
- Screenshots saved to temp (Y/N, count)
- Skill completed successfully (Y/N)

**Step 5: Restart Dispatch**
```bash
open -a Dispatch
```
  </action>
  <verify>
- Skill executes to completion without Dispatch
- Screenshots are saved to /tmp/screenshots-* directory
- No errors related to Dispatch unavailability (only info messages)
  </verify>
  <done>Skill execution verified working without Dispatch, with clear fallback behavior</done>
</task>

</tasks>

<verification>
## Fallback Verification Checks

1. **Health Check Fails Gracefully:**
   - `dispatch_check_health` returns 1 (failure)
   - No error spam, just clean failure

2. **dispatch_init Fallback:**
   - Creates /tmp/screenshots-[timestamp] directory
   - Sets DISPATCH_AVAILABLE=false
   - Outputs clear message to stderr (not stdout)
   - Returns 1 but doesn't crash

3. **dispatch_finalize Fallback:**
   - Outputs where screenshots remain
   - Returns 0 (success)
   - Cleans up state file

4. **Skill Integration:**
   - Skills work end-to-end without Dispatch
   - Screenshots saved to fallback location
   - No blocking errors
</verification>

<success_criteria>
- Library fallback tested and working
- Fallback messages are clear and actionable
- DISPATCH_AVAILABLE correctly set to false
- Screenshots saved to temp directory
- Skills complete successfully without Dispatch
- VERIFY-02 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/12-verification/12-01-SUMMARY.md` (or append to 12-01 if same session)
</output>
