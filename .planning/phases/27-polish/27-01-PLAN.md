---
phase: 27-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Services/HotkeyManager.swift
  - Dispatch/Models/AppSettings.swift
  - Dispatch/Views/Settings/SettingsView.swift
  - Dispatch/DispatchApp.swift
autonomous: true

must_haves:
  truths:
    - "User can invoke region capture via global keyboard shortcut from any app"
    - "User can invoke window capture via global keyboard shortcut from any app"
    - "Capture shortcuts are displayed in settings (non-editable for v3.0)"
    - "Shortcuts work independently of the main app toggle hotkey"
  artifacts:
    - path: "Dispatch/Services/HotkeyManager.swift"
      provides: "Multi-hotkey registration with unique IDs"
      contains: "func register(id:"
    - path: "Dispatch/Models/AppSettings.swift"
      provides: "Capture shortcut settings properties"
      contains: "regionCaptureKeyCode"
    - path: "Dispatch/Views/Settings/SettingsView.swift"
      provides: "Capture shortcuts display section"
      contains: "Capture Shortcuts"
  key_links:
    - from: "Dispatch/DispatchApp.swift"
      to: "HotkeyManager"
      via: "registerCaptureHotkeys call in setupApp"
      pattern: "registerCaptureHotkeys"
    - from: "HotkeyManager hotkey handler"
      to: "ScreenshotCaptureService"
      via: "captureRegion/captureWindow method call"
      pattern: "captureRegion|captureWindow"
---

<objective>
Add global keyboard shortcuts for region and window capture that work from any application.

Purpose: Enable rapid capture workflow without switching to Dispatch first. Users can press a shortcut from any app and immediately begin capture selection.

Output: Working global shortcuts (Ctrl+Cmd+1 for region, Ctrl+Cmd+2 for window), displayed in settings, registered at app startup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-polish/27-RESEARCH.md

# Prior phase context
@.planning/phases/26-sidebar-integration/26-01-SUMMARY.md

# Implementation references
@Dispatch/Services/HotkeyManager.swift
@Dispatch/Models/AppSettings.swift
@Dispatch/Views/Settings/SettingsView.swift
@Dispatch/DispatchApp.swift
@Dispatch/Services/ScreenshotCaptureService.swift
@Dispatch/Services/CaptureCoordinator.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-Hotkey Manager and AppSettings</name>
  <files>
    Dispatch/Services/HotkeyManager.swift
    Dispatch/Models/AppSettings.swift
  </files>
  <action>
Extend HotkeyManager to support multiple simultaneous hotkey registrations:

1. **HotkeyManager.swift changes:**
   - Add `HotkeyID` enum with cases: `appToggle = 1`, `regionCapture = 2`, `windowCapture = 3`
   - Change storage from single hotkey to dictionary: `private var hotkeys: [Int: (ref: EventHotKeyRef, handler: () -> Void)] = [:]`
   - Add `private var hotkeyIDs: [Int: EventHotKeyID] = [:]` to track IDs
   - Create new method `func register(id: Int, keyCode: Int, modifiers: Int, handler: @escaping () -> Void) -> Bool`:
     - If hotkey exists for this ID, unregister it first via `unregister(id:)`
     - Create EventHotKeyID with signature "DISP" and id = UInt32(id)
     - If eventHandler is nil (first registration), install the event handler
     - Register hotkey with Carbon RegisterEventHotKey
     - Store in hotkeys dictionary
   - Create `func unregister(id: Int)`:
     - Unregister specific hotkey by ID
     - Remove from dictionaries
   - Update event handler callback to dispatch to correct handler:
     - Extract EventHotKeyID from event using GetEventParameter
     - Look up handler in hotkeys dictionary by ID
     - Call the appropriate handler
   - Rename existing `isRegistered` to track whether event handler is installed
   - Keep existing `registerFromSettings()` working - it should call `register(id: HotkeyID.appToggle.rawValue, ...)`
   - Add `func unregisterAll()` that:
     - Iterates over hotkeys dictionary
     - Calls UnregisterEventHotKey for each ref
     - Clears both dictionaries
     - Sets eventHandler to nil if no hotkeys remain
   - Add `func registerCaptureHotkeys()` that:
     - Reads capture shortcut settings from `SettingsManager.shared.settings`
     - Registers region capture hotkey (if configured) with handler:
       ```swift
       Task { @MainActor in
           let result = await ScreenshotCaptureService.shared.captureRegion()
           CaptureCoordinator.shared.handleCaptureResult(result)
       }
       ```
     - Registers window capture hotkey (if configured) with handler:
       ```swift
       Task { @MainActor in
           let result = await ScreenshotCaptureService.shared.captureWindow()
           CaptureCoordinator.shared.handleCaptureResult(result)
       }
       ```
     - Logs registration success/failure via LoggingService

2. **AppSettings.swift changes:**
   - Add to AppSettingsDefaults:
     - `static let regionCaptureKeyCode: Int = kVK_ANSI_1` (the "1" key)
     - `static let regionCaptureModifiers: Int = Int(cmdKey | controlKey)` (Ctrl+Cmd)
     - `static let windowCaptureKeyCode: Int = kVK_ANSI_2` (the "2" key)
     - `static let windowCaptureModifiers: Int = Int(cmdKey | controlKey)` (Ctrl+Cmd)
   - Add properties to AppSettings model:
     - `var regionCaptureKeyCode: Int?`
     - `var regionCaptureModifiers: Int?`
     - `var windowCaptureKeyCode: Int?`
     - `var windowCaptureModifiers: Int?`
   - Update init to set defaults
   - Update resetToDefaults() to reset capture shortcuts
   - Add computed properties:
     - `var regionCaptureDescription: String` (like hotkeyDescription but for region)
     - `var windowCaptureDescription: String`
     - `var hasCaptureShortcuts: Bool`

**Default shortcuts:** Ctrl+Cmd+1 for region, Ctrl+Cmd+2 for window. These avoid conflicts with:
- System screenshot shortcuts (Cmd+Shift+3/4/5)
- App's existing menu shortcuts (Cmd+Shift+6/7)
- Common app shortcuts
  </action>
  <verify>
Build with `xcodebuild -scheme Dispatch build`. No errors. HotkeyManager supports multiple registrations with unique IDs. AppSettings has capture shortcut properties.
  </verify>
  <done>
HotkeyManager can register multiple hotkeys simultaneously. AppSettings stores capture shortcut configuration. Default shortcuts are Ctrl+Cmd+1 (region) and Ctrl+Cmd+2 (window).
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings UI and Startup Registration</name>
  <files>
    Dispatch/Views/Settings/SettingsView.swift
    Dispatch/DispatchApp.swift
  </files>
  <action>
1. **SettingsView.swift - Update HotkeySettingsView:**
   - Add new Section("Capture Shortcuts") after the existing "Options" section:
   ```swift
   Section("Capture Shortcuts") {
       HStack {
           Text("Region capture:")
           Spacer()
           Text(settingsManager.settings?.regionCaptureDescription ?? "Not Set")
               .padding(.horizontal, 12)
               .padding(.vertical, 6)
               .background(.quaternary, in: RoundedRectangle(cornerRadius: 6))
       }

       HStack {
           Text("Window capture:")
           Spacer()
           Text(settingsManager.settings?.windowCaptureDescription ?? "Not Set")
               .padding(.horizontal, 12)
               .padding(.vertical, 6)
               .background(.quaternary, in: RoundedRectangle(cornerRadius: 6))
       }

       Text("Capture shortcuts work from any application. Press the shortcut to start capture selection.")
           .font(.caption)
           .foregroundStyle(.secondary)
   }
   ```
   - This displays the shortcuts (read-only for v3.0, customization can come later)

2. **DispatchApp.swift - Wire up registration:**
   - In setupApp(), after `hotkeyManager.registerFromSettings()`, add:
     ```swift
     // Register capture hotkeys
     hotkeyManager.registerCaptureHotkeys()
     ```
   - In AppDelegate.applicationWillTerminate(), the existing `HotkeyManager.shared.unregister()` call needs to unregister all hotkeys. Update HotkeyManager to have `unregisterAll()` method and call that instead.
  </action>
  <verify>
1. Build and run the app
2. Open Settings > Hotkey tab
3. Verify "Capture Shortcuts" section shows with region (^Cmd+1) and window (^Cmd+2)
4. From another app (e.g., Finder), press Ctrl+Cmd+1
5. Verify region capture cross-hair appears
6. Press Escape to cancel
7. Press Ctrl+Cmd+2
8. Verify window capture hover-highlight mode begins
9. Press Escape to cancel
  </verify>
  <done>
Settings UI displays capture shortcuts. Hotkeys registered at app startup. Both Ctrl+Cmd+1 (region) and Ctrl+Cmd+2 (window) trigger captures from any application.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild -scheme Dispatch build`
2. App launches without crashes
3. Settings > Hotkey shows capture shortcuts section
4. From external app, Ctrl+Cmd+1 triggers region capture
5. From external app, Ctrl+Cmd+2 triggers window capture
6. Captures flow through to annotation window as expected
7. Original app toggle hotkey (Cmd+Shift+D) still works
</verification>

<success_criteria>
- [ ] HotkeyManager supports multiple simultaneous hotkey registrations
- [ ] AppSettings stores capture shortcut key codes and modifiers
- [ ] Settings UI displays capture shortcuts in Hotkey tab
- [ ] Ctrl+Cmd+1 triggers region capture from any app
- [ ] Ctrl+Cmd+2 triggers window capture from any app
- [ ] Original app toggle hotkey unaffected
- [ ] All hotkeys properly unregistered on app termination
</success_criteria>

<output>
After completion, create `.planning/phases/27-polish/27-01-SUMMARY.md`
</output>
