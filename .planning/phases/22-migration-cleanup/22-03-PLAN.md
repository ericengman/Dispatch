---
phase: 22-migration-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/ViewModels/PromptViewModel.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PromptViewModel.executePrompt() uses ExecutionManager instead of TerminalService"
    - "Direct prompt dispatch uses embedded terminal exclusively"
  artifacts:
    - path: "Dispatch/ViewModels/PromptViewModel.swift"
      provides: "Migrated prompt execution"
      pattern: "ExecutionManager\\.shared\\.execute"
  key_links:
    - from: "PromptViewModel.executePrompt"
      to: "ExecutionManager.execute"
      via: "direct call"
      pattern: "ExecutionManager\\.shared\\.execute"
---

<objective>
Migrate PromptViewModel.executePrompt() to use ExecutionManager

Purpose: PromptViewModel.executePrompt() still calls TerminalService.shared.dispatchPrompt() directly, bypassing the embedded terminal path. This is the primary prompt dispatch path (direct Cmd+Enter from prompt list) and must use ExecutionManager like History and Queue already do.

Output: Direct prompt sending uses embedded terminal via ExecutionManager.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-migration-cleanup/22-VERIFICATION.md
@Dispatch/ViewModels/PromptViewModel.swift
@Dispatch/ViewModels/HistoryViewModel.swift (reference: lines 117-127 show pattern)
@Dispatch/Services/ExecutionStateMachine.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate PromptViewModel.executePrompt() to ExecutionManager</name>
  <files>Dispatch/ViewModels/PromptViewModel.swift</files>
  <action>
1. In PromptViewModel.executePrompt() method (around line 320-345):

2. Replace the TerminalService call with ExecutionManager pattern:
   - Remove lines 330-335 that call TerminalService.shared.dispatchPrompt
   - Add ExecutionManager.execute call following the HistoryViewModel.resend() pattern:
     ```swift
     // Use ExecutionManager for embedded terminal dispatch
     try await ExecutionManager.shared.execute(
         content: content,
         title: prompt.displayTitle
     )
     ```

3. Update history entry creation (lines 342-343):
   - The current code creates history with windowId/windowName from TerminalService result
   - Change to pass nil for terminal identifiers since embedded terminal doesn't have window IDs:
     ```swift
     // Create history entry (no terminal window tracking for embedded)
     createHistoryEntry(for: prompt, windowId: nil, windowName: nil)
     ```

4. Remove the projectPath/projectName variables (lines 324-326) as they were only used for TerminalService terminal matching which is no longer needed.

5. Update the log message (line 344) to not reference terminal.displayName:
   ```swift
   logInfo("Prompt sent successfully: '\(prompt.displayTitle)'", category: .execution)
   ```

Why: ExecutionManager already handles embedded terminal dispatch with proper state machine, completion detection, and session tracking. PromptViewModel should use it like HistoryViewModel does.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService in executePrompt: `grep -n "TerminalService" Dispatch/ViewModels/PromptViewModel.swift`
ExecutionManager used: `grep -n "ExecutionManager.shared.execute" Dispatch/ViewModels/PromptViewModel.swift`
  </verify>
  <done>
PromptViewModel.executePrompt() calls ExecutionManager.shared.execute()
No TerminalService references remain in PromptViewModel
Direct prompt dispatch uses embedded terminal path
  </done>
</task>

</tasks>

<verification>
- Build: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
- No TerminalService usage: `grep -n "TerminalService" Dispatch/ViewModels/PromptViewModel.swift` returns nothing
- ExecutionManager pattern: `grep -n "ExecutionManager.shared.execute" Dispatch/ViewModels/PromptViewModel.swift` shows usage
</verification>

<success_criteria>
- PromptViewModel.executePrompt() uses ExecutionManager instead of TerminalService
- App builds without errors
- Prompt dispatch now routes through embedded terminal
</success_criteria>

<output>
After completion, create `.planning/phases/22-migration-cleanup/22-03-SUMMARY.md`
</output>
