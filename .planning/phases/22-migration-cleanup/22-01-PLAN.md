---
phase: 22-migration-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Services/TerminalService.swift
  - Dispatch/Services/ExecutionStateMachine.swift
  - Dispatch/ViewModels/QueueViewModel.swift
  - Dispatch/ViewModels/ChainViewModel.swift
autonomous: true

must_haves:
  truths:
    - "ExecutionManager only dispatches to embedded terminal"
    - "TerminalService is marked deprecated, not deleted"
    - "Queue and chain execution work without Terminal.app fallback"
  artifacts:
    - path: "Dispatch/Services/TerminalService.swift"
      provides: "Deprecated TerminalService actor"
      contains: "@available(*, deprecated"
    - path: "Dispatch/Services/ExecutionStateMachine.swift"
      provides: "Embedded-only ExecutionManager"
      pattern: "noTerminalAvailable"
  key_links:
    - from: "ExecutionManager.execute"
      to: "EmbeddedTerminalService.dispatchPrompt"
      via: "direct call without fallback"
      pattern: "embeddedService\\.dispatchPrompt"
---

<objective>
Replace Terminal.app dispatch path with embedded-only execution

Purpose: Remove the Terminal.app AppleScript fallback from ExecutionManager, making embedded terminal the sole execution path. This is the core service-layer migration.

Output: ExecutionManager dispatches exclusively to embedded terminals, TerminalService marked deprecated for potential rollback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-migration-cleanup/22-RESEARCH.md
@Dispatch/Services/ExecutionStateMachine.swift
@Dispatch/Services/TerminalService.swift
@Dispatch/Services/EmbeddedTerminalService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deprecate TerminalService and remove fallback from ExecutionManager</name>
  <files>
    Dispatch/Services/TerminalService.swift
    Dispatch/Services/ExecutionStateMachine.swift
  </files>
  <action>
1. In TerminalService.swift:
   - Add `@available(*, deprecated, message: "Use EmbeddedTerminalService instead. Terminal.app support will be removed in v3.0.")` before `actor TerminalService {`
   - Keep all implementation intact for potential rollback

2. In ExecutionStateMachine.swift - ExecutionManager.execute():
   - Remove the entire `else` block that calls terminalService (lines ~522-549)
   - Remove `private let terminalService = TerminalService.shared` property
   - Change the `if embeddedService.isAvailable` check to a `guard` statement:
     ```swift
     guard embeddedService.isAvailable else {
         throw ExecutionError.noTerminalAvailable
     }
     ```
   - Add new error case to ExecutionError enum:
     ```swift
     case noTerminalAvailable
     ```
   - Add errorDescription for new case:
     ```swift
     case .noTerminalAvailable:
         return "No embedded terminal session available. Create a session to dispatch prompts."
     ```
   - Remove startPolling call (only needed for Terminal.app path)
   - Keep startEmbeddedTerminalMonitoring (needed for embedded path)

3. In ExecutionStateMachine - startPolling():
   - Add `@available(*, deprecated, message: "Polling is only used for Terminal.app fallback")` annotation
   - Keep implementation for potential rollback

Why: Deprecation allows rollback if issues found, while removing active code paths that would create confusion.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService references in ExecutionManager except import (if any): `grep -n "terminalService" Dispatch/Services/ExecutionStateMachine.swift`
Deprecation warning visible when accessing TerminalService
  </verify>
  <done>
ExecutionManager.execute() has no Terminal.app fallback path
TerminalService marked deprecated but still compiles
New noTerminalAvailable error case exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Update QueueViewModel and ChainViewModel to remove Terminal.app parameters</name>
  <files>
    Dispatch/ViewModels/QueueViewModel.swift
    Dispatch/ViewModels/ChainViewModel.swift
  </files>
  <action>
1. In QueueViewModel.swift:
   - In executeItem() method, remove the targetWindowId and targetWindowName parameters from ExecutionManager.execute() call
   - Change from:
     ```swift
     try await ExecutionManager.shared.execute(
         content: resolveResult.resolvedText,
         title: item.displayTitle,
         targetWindowId: item.targetTerminalId,
         targetWindowName: item.targetTerminalName
     )
     ```
   - To:
     ```swift
     try await ExecutionManager.shared.execute(
         content: resolveResult.resolvedText,
         title: item.displayTitle
     )
     ```
   - Note: Keep the addToQueue and addInlineToQueue parameters for now (they're still used by UI, cleanup in plan 02)

2. In ChainViewModel.swift:
   - In startExecution() method signature, remove `targetWindowId: String? = nil` parameter
   - In executeItem() method, remove targetWindowId from ExecutionManager.execute() call
   - Change from:
     ```swift
     try await ExecutionManager.shared.execute(
         content: resolveResult.resolvedText,
         title: item.displayTitle,
         targetWindowId: targetWindowId,
         isFromChain: true,
         ...
     )
     ```
   - To:
     ```swift
     try await ExecutionManager.shared.execute(
         content: resolveResult.resolvedText,
         title: item.displayTitle,
         isFromChain: true,
         ...
     )
     ```

Why: These parameters are no longer used since embedded terminal targets via active session, not window ID.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No targetWindowId in execute calls: `grep -n "targetWindowId:" Dispatch/ViewModels/*.swift`
  </verify>
  <done>
QueueViewModel.executeItem() calls ExecutionManager without terminal targeting
ChainViewModel.executeItem() calls ExecutionManager without terminal targeting
App builds successfully
  </done>
</task>

</tasks>

<verification>
- Build: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
- Deprecation: TerminalService.shared access shows deprecation warning
- No fallback: grep -n "terminalService\." Dispatch/Services/ExecutionStateMachine.swift returns nothing
- Error case: ExecutionError.noTerminalAvailable exists
</verification>

<success_criteria>
- ExecutionManager.execute() uses embedded terminal exclusively
- Terminal.app fallback code removed from ExecutionManager
- TerminalService marked deprecated (not deleted)
- Queue and chain execution paths updated
- App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-migration-cleanup/22-01-SUMMARY.md`
</output>
