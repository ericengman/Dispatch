---
phase: 22-migration-cleanup
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/ViewModels/ProjectViewModel.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "ProjectViewModel.openInTerminal() creates embedded terminal session"
    - "No TerminalService calls in ProjectViewModel"
  artifacts:
    - path: "Dispatch/ViewModels/ProjectViewModel.swift"
      provides: "Migrated project terminal opening"
      pattern: "TerminalSessionManager"
  key_links:
    - from: "ProjectViewModel.openInTerminal"
      to: "TerminalSessionManager.createSession"
      via: "direct call"
      pattern: "createSession"
---

<objective>
Migrate ProjectViewModel.openInTerminal() to embedded terminal

Purpose: ProjectViewModel.openInTerminal() uses TerminalService.shared.openNewWindow() to open a Terminal.app window at the project path. This should instead create a new embedded terminal session with the project's working directory.

Output: Opening project in terminal creates embedded session instead of Terminal.app window.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-migration-cleanup/22-VERIFICATION.md
@Dispatch/ViewModels/ProjectViewModel.swift
@Dispatch/Services/TerminalSessionManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate openInTerminal() to create embedded session</name>
  <files>Dispatch/ViewModels/ProjectViewModel.swift</files>
  <action>
1. Find the openInTerminal() method (around line 269-283)

2. The current implementation:
   ```swift
   func openInTerminal(_ project: Project) {
       guard let pathURL = project.pathURL else {
           logWarning("Project '\(project.name)' has no file path", category: .data)
           return
       }

       Task {
           do {
               try await TerminalService.shared.openNewWindow(at: pathURL.path)
               logInfo("Opened project in Terminal: \(project.name)", category: .data)
           } catch {
               logError("Failed to open Terminal: \(error)", category: .data)
           }
       }
   }
   ```

3. Replace with embedded terminal session creation:
   ```swift
   /// Opens a project in a new embedded terminal session
   @MainActor
   func openInTerminal(_ project: Project) {
       guard let pathURL = project.pathURL else {
           logWarning("Project '\(project.name)' has no file path", category: .data)
           return
       }

       let sessionManager = TerminalSessionManager.shared

       // Check session limit
       guard sessionManager.canCreateSession else {
           logWarning("Cannot create terminal session: max limit reached", category: .data)
           return
       }

       // Create session with project name
       if let session = sessionManager.createSession(name: project.name) {
           // Set working directory for the session
           session.workingDirectory = pathURL.path

           // Associate session with project
           session.project = project

           // Make it the active session
           sessionManager.setActiveSession(session.id)

           logInfo("Created embedded terminal for project: \(project.name)", category: .data)
       } else {
           logError("Failed to create terminal session for project: \(project.name)", category: .data)
       }
   }
   ```

4. Add @MainActor annotation if not already present on the class or method (TerminalSessionManager is @MainActor).

5. Note: The EmbeddedTerminalView will pick up the workingDirectory and start the shell there when it initializes.

Why: Creating an embedded session provides the same functionality (terminal at project path) without requiring Terminal.app.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService: `grep -n "TerminalService" Dispatch/ViewModels/ProjectViewModel.swift`
SessionManager used: `grep -n "TerminalSessionManager" Dispatch/ViewModels/ProjectViewModel.swift`
  </verify>
  <done>
ProjectViewModel.openInTerminal() creates embedded terminal session
Session created with project name and working directory
No TerminalService references remain
  </done>
</task>

</tasks>

<verification>
- Build: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
- No TerminalService: `grep -n "TerminalService" Dispatch/ViewModels/ProjectViewModel.swift` returns nothing
- SessionManager: `grep -n "TerminalSessionManager" Dispatch/ViewModels/ProjectViewModel.swift` shows usage
</verification>

<success_criteria>
- openInTerminal() creates embedded terminal session
- Session has project name and working directory set
- No TerminalService references in ProjectViewModel
- App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-migration-cleanup/22-07-SUMMARY.md`
</output>
