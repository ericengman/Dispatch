---
phase: 22-migration-cleanup
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Views/Simulator/RunDetailView.swift
  - Dispatch/Views/Simulator/AnnotationWindow.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Simulator image dispatch uses EmbeddedTerminalService"
    - "No TerminalService calls in simulator views"
  artifacts:
    - path: "Dispatch/Views/Simulator/RunDetailView.swift"
      provides: "Migrated image dispatch"
      pattern: "EmbeddedTerminalService"
    - path: "Dispatch/Views/Simulator/AnnotationWindow.swift"
      provides: "Migrated annotation dispatch"
      pattern: "EmbeddedTerminalService"
  key_links:
    - from: "dispatchImagesToTerminal"
      to: "EmbeddedTerminalService.dispatchPrompt"
      via: "direct call"
      pattern: "dispatchPrompt"
---

<objective>
Migrate simulator image dispatch to embedded terminal

Purpose: RunDetailView and AnnotationWindow use TerminalService.pasteFromClipboard() and sendTextToActiveWindow() to dispatch annotated screenshots. These need to migrate to EmbeddedTerminalService for the embedded terminal path.

Output: Screenshot annotation dispatch uses embedded terminal exclusively.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-migration-cleanup/22-VERIFICATION.md
@Dispatch/Views/Simulator/RunDetailView.swift
@Dispatch/Views/Simulator/AnnotationWindow.swift
@Dispatch/Services/EmbeddedTerminalService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate RunDetailView.dispatchImagesToTerminal()</name>
  <files>Dispatch/Views/Simulator/RunDetailView.swift</files>
  <action>
1. Find dispatchImagesToTerminal() method (around line 285-310)

2. Replace the TerminalService calls with EmbeddedTerminalService:
   ```swift
   // Dispatch prompt text to embedded terminal
   let embeddedService = EmbeddedTerminalService.shared
   guard embeddedService.isAvailable else {
       dispatchError = "No embedded terminal available. Open a terminal session first."
       showingDispatchError = true
       return
   }

   let dispatched = embeddedService.dispatchPrompt(prompt)
   guard dispatched else {
       dispatchError = "Failed to dispatch to embedded terminal."
       showingDispatchError = true
       return
   }
   ```

3. Remove the catch blocks for TerminalServiceError (lines ~307-308) since embedded service does not throw.

4. Keep the clipboard copy call (annotationVM.copyToClipboard()) - images remain in clipboard for manual paste.

5. Simplify error handling to just clipboard copy failure case.

Note: Clipboard images are NOT automatically pasted. The workflow is: images copied to clipboard, prompt dispatched via dispatchPrompt(), user manually pastes images with Cmd+V if needed. This is a limitation of the embedded terminal approach.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService: `grep -n "TerminalService" Dispatch/Views/Simulator/RunDetailView.swift`
EmbeddedTerminalService used: `grep -n "EmbeddedTerminalService" Dispatch/Views/Simulator/RunDetailView.swift`
  </verify>
  <done>
RunDetailView.dispatchImagesToTerminal() uses EmbeddedTerminalService.dispatchPrompt()
No TerminalService references remain
Error handling updated for embedded terminal
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate AnnotationWindow.dispatchImagesToTerminal()</name>
  <files>Dispatch/Views/Simulator/AnnotationWindow.swift</files>
  <action>
1. Find dispatchImagesToTerminal() method (around line 375-412)

2. Replace the TerminalService calls with EmbeddedTerminalService:
   ```swift
   // Dispatch prompt text to embedded terminal
   let embeddedService = EmbeddedTerminalService.shared
   guard embeddedService.isAvailable else {
       dispatchError = "No embedded terminal available. Open a terminal session first."
       showingDispatchError = true
       return
   }

   let dispatched = embeddedService.dispatchPrompt(prompt)
   guard dispatched else {
       dispatchError = "Failed to dispatch to embedded terminal."
       showingDispatchError = true
       return
   }
   ```

3. Remove handleDispatchError() method (lines 414-429) that handles TerminalServiceError cases - not applicable to embedded terminal.

4. Remove or simplify openTerminalSettings() (line 431-434) since Terminal.app automation permission is no longer relevant.

5. Simplify error handling - remove `catch let error as TerminalServiceError` block, keep only generic error catch and clipboard failure handling.

Note: Same clipboard workflow as RunDetailView - images in clipboard, user pastes manually with Cmd+V if needed.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService: `grep -n "TerminalService" Dispatch/Views/Simulator/AnnotationWindow.swift`
EmbeddedTerminalService used: `grep -n "EmbeddedTerminalService" Dispatch/Views/Simulator/AnnotationWindow.swift`
  </verify>
  <done>
AnnotationWindow.dispatchImagesToTerminal() uses EmbeddedTerminalService.dispatchPrompt()
handleDispatchError() removed (TerminalServiceError not applicable)
No TerminalService references remain
  </done>
</task>

</tasks>

<verification>
- Build: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
- No TerminalService in simulator views:
  - `grep -n "TerminalService" Dispatch/Views/Simulator/RunDetailView.swift` returns nothing
  - `grep -n "TerminalService" Dispatch/Views/Simulator/AnnotationWindow.swift` returns nothing
- EmbeddedTerminalService used in both files
- Clipboard workflow note: Images are copied to clipboard and prompt is dispatched. Users must manually paste (Cmd+V) to include images in Claude Code input. This is expected behavior - automatic clipboard paste is not supported in the embedded terminal.
</verification>

<success_criteria>
- RunDetailView uses EmbeddedTerminalService for dispatch
- AnnotationWindow uses EmbeddedTerminalService for dispatch
- TerminalServiceError handling removed (not applicable)
- App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-migration-cleanup/22-05-SUMMARY.md`
</output>
