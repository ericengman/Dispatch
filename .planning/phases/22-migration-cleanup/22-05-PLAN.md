---
phase: 22-migration-cleanup
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Views/Simulator/RunDetailView.swift
  - Dispatch/Views/Simulator/AnnotationWindow.swift
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Simulator image dispatch uses EmbeddedTerminalService"
    - "No TerminalService calls in simulator views"
  artifacts:
    - path: "Dispatch/Views/Simulator/RunDetailView.swift"
      provides: "Migrated image dispatch"
      pattern: "EmbeddedTerminalService"
    - path: "Dispatch/Views/Simulator/AnnotationWindow.swift"
      provides: "Migrated annotation dispatch"
      pattern: "EmbeddedTerminalService"
  key_links:
    - from: "dispatchImagesToTerminal"
      to: "EmbeddedTerminalService.dispatchPrompt"
      via: "direct call"
      pattern: "dispatchPrompt"
---

<objective>
Migrate simulator image dispatch to embedded terminal

Purpose: RunDetailView and AnnotationWindow use TerminalService.pasteFromClipboard() and sendTextToActiveWindow() to dispatch annotated screenshots. These need to migrate to EmbeddedTerminalService for the embedded terminal path.

Output: Screenshot annotation dispatch uses embedded terminal exclusively.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/22-migration-cleanup/22-VERIFICATION.md
@Dispatch/Views/Simulator/RunDetailView.swift
@Dispatch/Views/Simulator/AnnotationWindow.swift
@Dispatch/Services/EmbeddedTerminalService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate RunDetailView.dispatchImagesToTerminal()</name>
  <files>Dispatch/Views/Simulator/RunDetailView.swift</files>
  <action>
1. In RunDetailView, find dispatchImagesToTerminal() method (around line 285-310)

2. The current pattern is:
   - Copy images to clipboard
   - Call TerminalService.shared.pasteFromClipboard()
   - Call TerminalService.shared.sendTextToActiveWindow(prompt)

3. Replace with embedded terminal approach:
   - Keep clipboard copy (annotationVM.copyToClipboard())
   - Use EmbeddedTerminalBridge to paste and send in one operation

4. Replace lines 294-300:
   ```swift
   // Paste images first via system paste command
   // Note: For embedded terminal, we send the paste command followed by prompt
   let pasteAndPrompt = "\u{16}" + prompt  // Ctrl+V paste + prompt
   // Actually, embedded terminal needs different approach:
   // Just dispatch the prompt - images are already in clipboard for user to paste
   let dispatched = await EmbeddedTerminalService.shared.dispatchPrompt(prompt)

   if !dispatched {
       // Fallback error handling
       logError("Failed to dispatch to embedded terminal", category: .simulator)
       return
   }
   ```

Wait - the embedded terminal doesn't support clipboard paste via code. The simpler approach is to dispatch just the prompt and let the user paste images manually, OR we can use the terminal's paste capability.

Actually, let me check EmbeddedTerminalBridge for paste support. Looking at SwiftTerm, it has sendPaste().

Revised approach for lines 294-310:
   ```swift
   // Get the embedded terminal coordinator
   let bridge = EmbeddedTerminalBridge.shared
   guard let coordinator = bridge.activeCoordinator else {
       dispatchError = "No embedded terminal available. Open a terminal session first."
       showingDispatchError = true
       return
   }

   // Paste from clipboard (images)
   coordinator.pasteFromClipboard()

   // Small delay to ensure paste completes
   try await Task.sleep(nanoseconds: 200_000_000) // 200ms

   // Send the prompt text
   let dispatched = EmbeddedTerminalService.shared.dispatchPrompt(prompt)
   guard dispatched else {
       dispatchError = "Failed to dispatch prompt to terminal."
       showingDispatchError = true
       return
   }
   ```

But wait - we need to check if EmbeddedTerminalView.Coordinator has pasteFromClipboard. Let me assume it needs to be added or use terminal.sendPaste().

Actually, the SwiftTerm LocalProcessTerminalView has a paste command. Let me use a simpler approach:

   ```swift
   // Dispatch to embedded terminal
   // Note: Images are in clipboard - dispatch prompt, user can paste images in Claude Code
   let embeddedService = EmbeddedTerminalService.shared
   guard embeddedService.isAvailable else {
       dispatchError = "No embedded terminal available. Open a terminal session first."
       showingDispatchError = true
       return
   }

   let dispatched = embeddedService.dispatchPrompt(prompt)
   guard dispatched else {
       dispatchError = "Failed to dispatch to embedded terminal."
       showingDispatchError = true
       return
   }
   ```

Note: The clipboard still has images. Claude Code can read them if the user pastes (Cmd+V) or the prompt can reference "the image in clipboard".

5. Remove the catch blocks for TerminalServiceError (lines ~307-308) since embedded service doesn't throw.

6. Simplify error handling to just the clipboard copy failure case.

Why: EmbeddedTerminalService.dispatchPrompt is the standard path. Clipboard paste is a UX consideration - users can manually paste or we can enhance later.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService: `grep -n "TerminalService" Dispatch/Views/Simulator/RunDetailView.swift`
EmbeddedTerminalService used: `grep -n "EmbeddedTerminalService" Dispatch/Views/Simulator/RunDetailView.swift`
  </verify>
  <done>
RunDetailView.dispatchImagesToTerminal() uses EmbeddedTerminalService
No TerminalService references remain
Error handling updated for embedded terminal
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate AnnotationWindow.dispatchImagesToTerminal()</name>
  <files>Dispatch/Views/Simulator/AnnotationWindow.swift</files>
  <action>
1. In AnnotationWindow, find dispatchImagesToTerminal() method (around line 375-412)

2. Same pattern as RunDetailView - replace TerminalService calls with EmbeddedTerminalService.

3. Replace lines 385-391 with:
   ```swift
   // Dispatch to embedded terminal
   let embeddedService = EmbeddedTerminalService.shared
   guard embeddedService.isAvailable else {
       dispatchError = "No embedded terminal available. Open a terminal session first."
       showingDispatchError = true
       return
   }

   let dispatched = embeddedService.dispatchPrompt(prompt)
   guard dispatched else {
       dispatchError = "Failed to dispatch to embedded terminal."
       showingDispatchError = true
       return
   }
   ```

4. Remove the handleDispatchError() method (lines 414-429) that handles TerminalServiceError cases. These errors don't apply to embedded terminal.

5. Simplify the error handling in dispatchImagesToTerminal:
   - Remove the `catch let error as TerminalServiceError` block
   - Keep only the generic error catch and clipboard failure handling

6. Remove or simplify openTerminalSettings() (line 431-434) since it's for Terminal.app automation permission which is no longer relevant.

Why: Same migration pattern as RunDetailView - use embedded terminal exclusively.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20`
No TerminalService: `grep -n "TerminalService" Dispatch/Views/Simulator/AnnotationWindow.swift`
EmbeddedTerminalService used: `grep -n "EmbeddedTerminalService" Dispatch/Views/Simulator/AnnotationWindow.swift`
  </verify>
  <done>
AnnotationWindow.dispatchImagesToTerminal() uses EmbeddedTerminalService
handleDispatchError() removed (TerminalServiceError not applicable)
No TerminalService references remain
  </done>
</task>

</tasks>

<verification>
- Build: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
- No TerminalService in simulator views:
  - `grep -n "TerminalService" Dispatch/Views/Simulator/RunDetailView.swift` returns nothing
  - `grep -n "TerminalService" Dispatch/Views/Simulator/AnnotationWindow.swift` returns nothing
- EmbeddedTerminalService used in both files
</verification>

<success_criteria>
- RunDetailView uses EmbeddedTerminalService for dispatch
- AnnotationWindow uses EmbeddedTerminalService for dispatch
- TerminalServiceError handling removed (not applicable)
- App builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-migration-cleanup/22-05-SUMMARY.md`
</output>
