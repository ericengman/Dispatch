---
phase: 23-region-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Services/ScreenshotCaptureService.swift
  - Dispatch/Services/LoggingService.swift
  - Dispatch/Views/MainView.swift
autonomous: true

must_haves:
  truths:
    - "User can trigger region capture and see native macOS cross-hair cursor"
    - "User can drag to select any rectangular area on any display"
    - "Captured image is saved to Dispatch's QuickCaptures directory"
    - "Cancelled captures (Escape key) are handled gracefully"
  artifacts:
    - path: "Dispatch/Services/ScreenshotCaptureService.swift"
      provides: "Region capture via screencapture CLI"
      exports: ["ScreenshotCaptureService", "CaptureResult"]
    - path: "Dispatch/Services/LoggingService.swift"
      provides: "capture log category"
      contains: "case capture"
  key_links:
    - from: "Dispatch/Views/MainView.swift"
      to: "ScreenshotCaptureService"
      via: "temporary menu bar trigger"
      pattern: "captureRegion"
    - from: "ScreenshotCaptureService"
      to: "FileManager"
      via: "QuickCaptures directory creation"
      pattern: "QuickCaptures"
---

<objective>
Create ScreenshotCaptureService that invokes native macOS `screencapture -i` for region selection.

Purpose: Establish the capture service foundation that Phase 24+ will build upon. Native screencapture provides perfect cross-hair UX with no custom UI needed.
Output: Working region capture that saves to QuickCaptures directory, triggered via temporary menu item.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/STACK-v3-screenshot-capture.md
@.planning/research/ARCHITECTURE-v3-screenshot-capture.md
@.planning/research/PITFALLS-v3-screenshot-capture.md

@Dispatch/Services/ScreenshotWatcherService.swift (pattern for Application Support directory handling)
@Dispatch/Services/LoggingService.swift (add capture category)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScreenshotCaptureService with region capture</name>
  <files>
    Dispatch/Services/ScreenshotCaptureService.swift
    Dispatch/Services/LoggingService.swift
  </files>
  <action>
Create `ScreenshotCaptureService.swift` as a @MainActor singleton following existing service patterns.

**Service structure:**
```swift
@MainActor
final class ScreenshotCaptureService {
    static let shared = ScreenshotCaptureService()

    /// QuickCaptures directory in Application Support
    private let capturesDirectory: URL

    private init() {
        // Initialize capturesDirectory to ~/Library/Application Support/Dispatch/QuickCaptures/
        // Use same pattern as ScreenshotWatcherService.ScreenshotDirectoryConfig.defaultBaseDirectory
    }
}
```

**CaptureResult enum:**
```swift
enum CaptureResult {
    case success(URL)      // Path to saved screenshot
    case cancelled         // User pressed Escape
    case error(Error)      // screencapture failed
}
```

**captureRegion() method:**
```swift
func captureRegion() async -> CaptureResult {
    // 1. Ensure QuickCaptures directory exists (create if needed)
    // 2. Generate unique filename: {UUID}.png
    // 3. Invoke screencapture -i -x {path}
    // 4. Check Process.terminationStatus:
    //    - Status 0 + file exists = .success(path)
    //    - Status 0 + no file = .cancelled (user pressed Escape)
    //    - Non-zero status = .error
    // 5. Log result with .capture category
}
```

**Key implementation details:**
- Use `/usr/sbin/screencapture` as executable path
- Arguments: `["-i", "-x", outputPath.path]`
  - `-i` = interactive (cross-hair selection)
  - `-x` = no sound
- Run process with `try process.run()` and `process.waitUntilExit()`
- Log debug info for each capture attempt and result

**Add to LoggingService.swift:**
- Add new case `capture = "CAPTURE"` to LogCategory enum
- This follows existing pattern (simulator, status, etc.)

**Directory location:**
```swift
FileManager.default.urls(for: .applicationSupportDirectory, in: .userDomainMask).first!
    .appendingPathComponent("Dispatch/QuickCaptures", isDirectory: true)
```
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
  </verify>
  <done>
ScreenshotCaptureService exists with captureRegion() method. LoggingService has .capture category.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add temporary region capture trigger to MainView</name>
  <files>
    Dispatch/Views/MainView.swift
  </files>
  <action>
Add a temporary keyboard shortcut to trigger region capture for testing. This will be replaced by proper sidebar UI in Phase 26.

**Add to MainView:**
1. Add `.onKeyPress` or keyboard shortcut for Command+Shift+5 (or similar non-conflicting combo)
2. Alternatively, add a temporary toolbar button that calls `captureRegion()`

**Recommended approach - use .commands modifier:**
```swift
.commands {
    CommandGroup(after: .newItem) {
        Button("Capture Region") {
            Task {
                let result = await ScreenshotCaptureService.shared.captureRegion()
                switch result {
                case .success(let url):
                    logInfo("Region captured: \(url.lastPathComponent)", category: .capture)
                case .cancelled:
                    logInfo("Region capture cancelled", category: .capture)
                case .error(let error):
                    logError("Region capture failed: \(error)", category: .capture)
                }
            }
        }
        .keyboardShortcut("6", modifiers: [.command, .shift])
    }
}
```

**Note:** Use Cmd+Shift+6 to avoid conflict with macOS native Cmd+Shift+5 screenshot.

This is temporary scaffolding - Phase 26 will add the proper sidebar Quick Capture section.
  </action>
  <verify>
1. Build and run app
2. Press Cmd+Shift+6 (or use Edit menu > Capture Region)
3. Verify cross-hair cursor appears
4. Drag to select a region
5. Check QuickCaptures directory for saved PNG:
   `ls ~/Library/Application\ Support/Dispatch/QuickCaptures/`
6. Press Escape during capture - verify no file is created
  </verify>
  <done>
Region capture can be triggered via menu/keyboard. Native cross-hair appears. Screenshots save to QuickCaptures directory.
  </done>
</task>

</tasks>

<verification>
1. **Build verification:** `xcodebuild -scheme Dispatch -destination 'platform=macOS' build` passes
2. **Functional test:**
   - Trigger region capture via Cmd+Shift+6
   - Native macOS cross-hair cursor appears
   - Select any region on screen
   - PNG file appears in `~/Library/Application Support/Dispatch/QuickCaptures/`
3. **Cancel test:**
   - Trigger region capture
   - Press Escape
   - No new file created, no errors logged
4. **Multi-display test (if available):**
   - Capture region from secondary display
   - Verify correct region is captured
</verification>

<success_criteria>
- [ ] ScreenshotCaptureService.swift exists with captureRegion() -> CaptureResult
- [ ] LoggingService has .capture category
- [ ] Cmd+Shift+6 triggers region capture in running app
- [ ] Cross-hair selection uses native macOS UX (not custom overlay)
- [ ] Captured PNGs save to QuickCaptures directory
- [ ] Escape cancels capture gracefully (no file, no error)
- [ ] Console shows appropriate logs with [CAPTURE] category
</success_criteria>

<output>
After completion, create `.planning/phases/23-region-capture/23-01-SUMMARY.md`
</output>
