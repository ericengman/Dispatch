---
phase: 14-swiftterm-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch.xcodeproj/project.pbxproj
  - Dispatch/Views/Terminal/EmbeddedTerminalView.swift
  - Dispatch/Views/MainView.swift
autonomous: true

must_haves:
  truths:
    - "SwiftTerm package resolves and project builds"
    - "User can see embedded terminal in the app window"
    - "User can type commands and see output"
    - "ANSI colors render correctly (ls --color shows colored output)"
  artifacts:
    - path: "Dispatch/Views/Terminal/EmbeddedTerminalView.swift"
      provides: "NSViewRepresentable wrapping LocalProcessTerminalView"
      min_lines: 40
      exports: ["EmbeddedTerminalView"]
    - path: "Dispatch.xcodeproj/project.pbxproj"
      provides: "SwiftTerm package reference"
      contains: "SwiftTerm"
  key_links:
    - from: "Dispatch/Views/MainView.swift"
      to: "EmbeddedTerminalView"
      via: "View embedding in detail area"
      pattern: "EmbeddedTerminalView"
    - from: "EmbeddedTerminalView"
      to: "LocalProcessTerminalView"
      via: "NSViewRepresentable makeNSView"
      pattern: "LocalProcessTerminalView"
---

<objective>
Add SwiftTerm package and create EmbeddedTerminalView that renders an interactive bash shell in the Dispatch window.

Purpose: This is the foundation for v2.0's embedded Claude Code sessions, replacing Terminal.app dependency.
Output: Working terminal view with shell access, ANSI color support, and proper SwiftUI integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-swiftterm-integration/14-RESEARCH.md

# Reference existing structure
@Dispatch/Views/MainView.swift
@Dispatch/Dispatch.entitlements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SwiftTerm Package Dependency</name>
  <files>Dispatch.xcodeproj/project.pbxproj</files>
  <action>
Add SwiftTerm package via Xcode SPM:
1. Open Dispatch.xcodeproj in Xcode
2. File > Add Package Dependencies
3. URL: https://github.com/migueldeicaza/SwiftTerm
4. Version Rule: Up to Next Minor from 1.10.0
5. Add SwiftTerm to Dispatch target

The entitlements already have App Sandbox disabled (confirmed), which is required for LocalProcessTerminalView to work.

Use xcodebuild to verify the package resolves and builds:
```bash
xcodebuild -project Dispatch.xcodeproj -scheme Dispatch -configuration Debug build
```

Do NOT use Xcode GUI commands via AppleScript for adding packages - this must be done by directly resolving packages via xcodebuild or by manually editing Package.resolved if needed. If the project uses SPM integration, add via Package.swift or use swift package resolve.
  </action>
  <verify>
`xcodebuild -project Dispatch.xcodeproj -scheme Dispatch build` succeeds with no errors.
`import SwiftTerm` compiles without errors in a new Swift file.
  </verify>
  <done>SwiftTerm 1.10.x is in Package.resolved and project builds successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Create EmbeddedTerminalView</name>
  <files>Dispatch/Views/Terminal/EmbeddedTerminalView.swift</files>
  <action>
Create new file at Dispatch/Views/Terminal/EmbeddedTerminalView.swift implementing NSViewRepresentable wrapper for LocalProcessTerminalView.

Follow the pattern from 14-RESEARCH.md:

```swift
import SwiftUI
import SwiftTerm

struct EmbeddedTerminalView: NSViewRepresentable {
    typealias NSViewType = LocalProcessTerminalView

    // Optional callback for process exit
    var onProcessExit: ((Int32?) -> Void)?

    func makeNSView(context: Context) -> LocalProcessTerminalView {
        let terminal = LocalProcessTerminalView(frame: .zero)
        terminal.terminalDelegate = context.coordinator

        // Use user's default shell
        let shell = ProcessInfo.processInfo.environment["SHELL"] ?? "/bin/bash"
        terminal.startProcess(executable: shell)

        return terminal
    }

    func updateNSView(_ nsView: LocalProcessTerminalView, context: Context) {
        // Update coordinator's callback reference
        context.coordinator.onProcessExit = onProcessExit
    }

    func makeCoordinator() -> Coordinator {
        Coordinator(onProcessExit: onProcessExit)
    }

    class Coordinator: NSObject, LocalProcessTerminalViewDelegate {
        var onProcessExit: ((Int32?) -> Void)?

        init(onProcessExit: ((Int32?) -> Void)?) {
            self.onProcessExit = onProcessExit
            super.init()
        }

        func processTerminated(_ source: TerminalView, exitCode: Int32?) {
            logDebug("Terminal process exited with code: \(exitCode ?? -1)", category: .terminal)
            DispatchQueue.main.async {
                self.onProcessExit?(exitCode)
            }
        }

        func sizeChanged(source: TerminalView, newCols: Int, newRows: Int) {
            logDebug("Terminal resized to \(newCols)x\(newRows)", category: .terminal)
        }
    }
}
```

Key implementation notes:
- Only create terminal in makeNSView (not updateNSView) to prevent shell restarts
- Use $SHELL environment variable to respect user's default shell
- Delegate methods dispatch to main thread for SwiftUI safety
- Use LoggingService for debug logging (add .terminal category if missing)
  </action>
  <verify>
File exists at Dispatch/Views/Terminal/EmbeddedTerminalView.swift.
File imports SwiftTerm and SwiftUI.
Coordinator implements LocalProcessTerminalViewDelegate.
  </verify>
  <done>EmbeddedTerminalView.swift exists with NSViewRepresentable implementation and proper delegate handling.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Terminal into MainView</name>
  <files>Dispatch/Views/MainView.swift</files>
  <action>
Add a temporary terminal panel to MainView for testing. Place it in a way that allows verification without disrupting the existing UI.

Option A (recommended): Add as a toggleable panel in the detail area
- Add @State private var showTerminal: Bool = false
- Add toolbar button to toggle terminal
- Show EmbeddedTerminalView in an HSplit or below content when toggled

Option B: Replace content area temporarily (just for this phase)

Implementation for Option A - add to MainView:

1. Add state:
```swift
@State private var showTerminal: Bool = false
```

2. Add toolbar button in toolbarContent:
```swift
Button {
    showTerminal.toggle()
} label: {
    Label("Terminal", systemImage: showTerminal ? "terminal.fill" : "terminal")
}
.keyboardShortcut("t", modifiers: [.command, .shift])
```

3. Modify the detail area to show terminal when toggled. In the body's VStack, add a conditional split:
```swift
if showTerminal {
    HSplitView {
        // Existing content
        contentWrapper

        // Terminal panel
        EmbeddedTerminalView()
            .frame(minWidth: 400)
    }
} else {
    contentWrapper
}
```

Where contentWrapper encapsulates the existing HStack with SkillsSidePanel logic.

Build and run the app to verify terminal appears, accepts input, shows colored output.
  </action>
  <verify>
Build succeeds: `xcodebuild -project Dispatch.xcodeproj -scheme Dispatch build`
App runs and shows terminal toggle button in toolbar.
Clicking toggle (or Cmd+Shift+T) shows/hides embedded terminal.
Typing `ls --color` in terminal shows colored output.
  </verify>
  <done>
Terminal panel is accessible via toolbar button.
User can type commands and see output.
ANSI colors render correctly.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify end-to-end:

1. **Build verification:**
   ```bash
   xcodebuild -project Dispatch.xcodeproj -scheme Dispatch -configuration Debug build
   ```
   Must complete with 0 errors.

2. **Runtime verification:**
   - Launch Dispatch app
   - Click terminal button in toolbar (or Cmd+Shift+T)
   - Terminal panel appears on right side
   - Type `echo "Hello World"` - see output
   - Type `ls --color` - see colored file listing
   - Type `python3 --version` or `git --version` - commands execute
   - Close and reopen terminal - shell restarts cleanly

3. **ANSI color verification:**
   - Type `printf '\033[31mRed\033[0m \033[32mGreen\033[0m \033[34mBlue\033[0m\n'`
   - Should show Red, Green, Blue in respective colors
</verification>

<success_criteria>
- [ ] SwiftTerm package in project dependencies (Package.resolved)
- [ ] Project builds without errors
- [ ] EmbeddedTerminalView.swift exists with NSViewRepresentable implementation
- [ ] MainView has terminal toggle button
- [ ] Terminal accepts keyboard input
- [ ] Commands execute and show output
- [ ] ANSI colors render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/14-swiftterm-integration/14-01-SUMMARY.md`
</output>
