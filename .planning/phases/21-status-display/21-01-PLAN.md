---
phase: 21-status-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Models/SessionStatus.swift
  - Dispatch/Services/SessionStatusMonitor.swift
  - Dispatch/Views/Components/SessionStatusView.swift
  - Dispatch/Views/Terminal/SessionTabBar.swift
  - Dispatch/Services/TerminalSessionManager.swift
  - Dispatch/Services/LoggingService.swift
autonomous: true

must_haves:
  truths:
    - "User sees current state (Thinking/Executing/Idle) for active session"
    - "User sees context window usage as percentage indicator"
    - "Status updates within ~1 second as Claude Code progresses"
    - "Closing session stops file monitoring cleanly"
  artifacts:
    - path: "Dispatch/Models/SessionStatus.swift"
      provides: "SessionState enum and ContextUsage struct"
      contains: "enum SessionState"
    - path: "Dispatch/Services/SessionStatusMonitor.swift"
      provides: "File monitoring and JSONL parsing"
      exports: ["SessionStatusMonitor"]
    - path: "Dispatch/Views/Components/SessionStatusView.swift"
      provides: "Status badge and context indicator UI"
      min_lines: 40
  key_links:
    - from: "SessionStatusMonitor"
      to: "~/.claude/projects/{path}/*.jsonl"
      via: "DispatchSource.FileSystemObject"
      pattern: "DispatchSource\\.makeFileSystemObjectSource"
    - from: "SessionTabBar"
      to: "SessionStatusView"
      via: "embedded component"
      pattern: "SessionStatusView"
    - from: "TerminalSessionManager"
      to: "SessionStatusMonitor"
      via: "monitor registry"
      pattern: "statusMonitors\\["
---

<objective>
Parse Claude Code JSONL session files in real-time to display rich status (thinking, executing, idle) and context window usage percentage in the session tab bar.

Purpose: Gives users visibility into Claude Code's current state and context consumption without switching to the terminal, enabling informed decisions about when to dispatch prompts.

Output: SessionStatus model, SessionStatusMonitor service, SessionStatusView component integrated into SessionTabBar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-status-display/21-RESEARCH.md
@Dispatch/Models/TerminalSession.swift
@Dispatch/Services/TerminalSessionManager.swift
@Dispatch/Views/Terminal/SessionTabBar.swift
@Dispatch/Services/LoggingService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionStatus model and SessionStatusMonitor service</name>
  <files>
    Dispatch/Models/SessionStatus.swift
    Dispatch/Services/SessionStatusMonitor.swift
    Dispatch/Services/LoggingService.swift
  </files>
  <action>
Create the data model and file monitoring service for JSONL parsing:

**SessionStatus.swift:**
- `SessionState` enum: `idle`, `thinking`, `executing`, `waiting` with display names
- `ContextUsage` struct: `inputTokens: Int`, `outputTokens: Int`, `cacheTokens: Int?`
- `SessionStatus` struct: `state: SessionState`, `contextUsage: ContextUsage?`, `lastUpdated: Date`
- Add computed `contextPercentage: Double` (total / 200_000 model limit)
- Add computed `usageColor: Color` (green < 70%, orange 70-90%, red > 90%)

**SessionStatusMonitor.swift:**
- `@Observable @MainActor final class SessionStatusMonitor`
- Properties: `private(set) var status: SessionStatus`, `private var fileDescriptor: Int32`, `private var dispatchSource: DispatchSourceFileSystemObject?`, `private var lastOffset: UInt64`
- `startMonitoring(sessionId: UUID, workingDirectory: String)`:
  - Build JSONL path: `~/.claude/projects/{encodedPath}/{sessionId.uuidString}.jsonl`
  - Encode path: replace `/` with `-` (e.g., `/Users/eric/Dispatch` -> `-Users-eric-Dispatch`)
  - If file doesn't exist, retry with 500ms delay up to 5s (file created after first prompt)
  - Open file with `O_EVTONLY`, create DispatchSource for `.write, .extend` events
  - Set event handler to call `handleFileUpdate()` on `.userInitiated` queue
  - Set cancel handler to close file descriptor
  - Resume source
- `handleFileUpdate()`:
  - Open FileHandle for reading
  - Seek to `lastOffset`
  - Read to end of file, update `lastOffset`
  - Parse newline-delimited JSON entries
  - Call `updateFromEntries(_:)` on main thread
- `updateFromEntries(_ entries: [JSONLEntry])`:
  - For each entry, detect state changes:
    - `type == "message"` with `message.role == "assistant"` and `stop_reason != nil` -> `.thinking`
    - `message.content` contains `tool_use` type -> `.executing`
    - `message.content` contains `tool_result` type -> `.executing`
    - `type == "hook_progress"` with `hookEvent == "Stop"` -> `.idle`
  - Extract token usage from `message.usage` (input_tokens, output_tokens, cache_read_input_tokens)
  - Update `status` property (triggers SwiftUI update)
- `stopMonitoring()`: cancel source, set to nil
- Nested `JSONLEntry` struct matching Claude Code format (see research doc)

**LoggingService.swift:**
- Add `status` case to `LogCategory` enum for status monitoring logs

Use extensive logging with `.status` category for all monitoring events.
  </action>
  <verify>
Project builds with `xcodebuild -scheme Dispatch build`. New files exist and contain required types. LogCategory.status exists.
  </verify>
  <done>
SessionStatus model defines state enum and context usage. SessionStatusMonitor can watch JSONL files and parse entries to update status.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SessionStatusView component</name>
  <files>
    Dispatch/Views/Components/SessionStatusView.swift
  </files>
  <action>
Create the UI component for displaying session status:

**SessionStatusView.swift:**
- `struct SessionStatusView: View`
- Property: `let status: SessionStatus`
- Body layout (horizontal, compact for tab bar):
  - State badge: colored circle (4pt) + state text (caption font)
    - Idle: gray circle, "Idle" text
    - Thinking: blue circle with pulse animation, "Thinking" text
    - Executing: orange circle with pulse animation, "Executing" text
    - Waiting: yellow circle, "Waiting" text
  - Context indicator (only show if contextUsage != nil):
    - Small circular progress ring (20pt diameter)
    - Color based on percentage (green/orange/red)
    - Percentage text inside ring (caption2 font)
    - Tooltip showing exact token counts

State badge pulse animation:
```swift
@State private var isPulsing = false
// In body, for thinking/executing states:
Circle()
    .fill(color)
    .scaleEffect(isPulsing ? 1.2 : 1.0)
    .opacity(isPulsing ? 0.7 : 1.0)
    .animation(.easeInOut(duration: 0.8).repeatForever(autoreverses: true), value: isPulsing)
    .onAppear { isPulsing = true }
```

Context ring (simplified from research, not full ProgressView):
```swift
ZStack {
    Circle().stroke(Color.gray.opacity(0.2), lineWidth: 2)
    Circle()
        .trim(from: 0, to: status.contextPercentage)
        .stroke(status.usageColor, style: StrokeStyle(lineWidth: 2, lineCap: .round))
        .rotationEffect(.degrees(-90))
    Text("\(Int(status.contextPercentage * 100))%")
        .font(.system(size: 8, design: .rounded))
}
.frame(width: 20, height: 20)
```

Add Preview with sample status data for each state.
  </action>
  <verify>
Project builds. SessionStatusView.swift exists with View conformance and Preview.
  </verify>
  <done>
SessionStatusView displays state badge with animations and context usage ring with color-coded percentage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate status monitoring into session lifecycle</name>
  <files>
    Dispatch/Services/TerminalSessionManager.swift
    Dispatch/Views/Terminal/SessionTabBar.swift
  </files>
  <action>
Wire status monitoring into session management and display in tab bar:

**TerminalSessionManager.swift:**
- Add property: `private(set) var statusMonitors: [UUID: SessionStatusMonitor] = [:]`
- Add method: `func startStatusMonitoring(for session: TerminalSession)`:
  - Guard session has claudeSessionId and workingDirectory
  - Create new SessionStatusMonitor
  - Call monitor.startMonitoring(sessionId: UUID(uuidString: claudeSessionId)!, workingDirectory: workingDirectory)
  - Store in statusMonitors dictionary
  - Log: "Started status monitoring for session \(session.id)"
- Add method: `func stopStatusMonitoring(for sessionId: UUID)`:
  - Get monitor from dictionary
  - Call monitor.stopMonitoring()
  - Remove from dictionary
  - Log: "Stopped status monitoring for session \(sessionId)"
- Add method: `func statusMonitor(for sessionId: UUID) -> SessionStatusMonitor?`:
  - Return statusMonitors[sessionId]
- Update `closeSession(_:)`: call `stopStatusMonitoring(for: sessionId)` before cleanup
- Update `createResumeSession(claudeSession:)`: call `startStatusMonitoring(for: session)` after creation
- Note: For new sessions (not resume), monitoring starts when claudeSessionId is set (after first prompt - future enhancement)

**SessionTabBar.swift:**
- Import SessionStatusMonitor (if needed)
- In `SessionTab` view:
  - Add: `@State private var statusMonitor: SessionStatusMonitor?`
  - In `.onAppear`: `statusMonitor = TerminalSessionManager.shared.statusMonitor(for: session.id)`
  - After session name Text, add SessionStatusView if monitor has status:
    ```swift
    if let monitor = statusMonitor, monitor.status.state != .idle {
        SessionStatusView(status: monitor.status)
    }
    ```
  - This shows status only when active (thinking/executing), hides when idle to reduce visual noise
- Alternatively, always show status in tab for active session:
  - Check `isActive` and show status unconditionally for active session

Test approach: Since we can't easily mock JSONL files, verify monitoring starts/stops correctly via logs. UI component renders with mock data in Preview.
  </action>
  <verify>
Build succeeds. Launch app, create a resumed session with Claude session ID. Check logs for "Started status monitoring" message. Status appears in tab bar when session is active (may need manual JSONL file inspection to confirm updates).
  </verify>
  <done>
Status monitoring starts when sessions with Claude session IDs are created. SessionTabBar shows SessionStatusView for active sessions. Monitoring stops cleanly on session close.
  </done>
</task>

</tasks>

<verification>
1. `xcodebuild -scheme Dispatch build` succeeds
2. New files exist:
   - Dispatch/Models/SessionStatus.swift
   - Dispatch/Services/SessionStatusMonitor.swift
   - Dispatch/Views/Components/SessionStatusView.swift
3. LogCategory.status case exists
4. TerminalSessionManager has statusMonitors dictionary and lifecycle methods
5. SessionTabBar includes SessionStatusView component
6. Log output shows status monitoring lifecycle on session create/close
</verification>

<success_criteria>
- Session status model defines state (idle/thinking/executing/waiting) and context usage
- SessionStatusMonitor uses DispatchSource to watch JSONL files for changes
- JSONL entries are parsed incrementally (tail-reading pattern)
- SessionStatusView shows animated state badge and context percentage ring
- Status monitoring integrates with session lifecycle (start on create, stop on close)
- Tab bar displays status for active/resumed sessions
</success_criteria>

<output>
After completion, create `.planning/phases/21-status-display/21-01-SUMMARY.md`
</output>
