---
phase: 11-skill-migration
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "No inline Dispatch integration code remains in any skill"
    - "All screenshot-taking skills use the shared library"
    - "Verification confirms migration is complete"
  artifacts: []
  key_links:
    - from: "All migrated skills"
      to: "~/.claude/lib/dispatch.sh"
      via: "source command"
      pattern: "source ~/.claude/lib/dispatch.sh"
---

<objective>
Verify all screenshot-taking skills have been migrated to use the shared library, confirming no duplicated Dispatch integration code remains.

Purpose: Final verification that Phase 11 migration is complete - all 4 identified skills now source the shared library instead of containing inline integration code.

Output: Verification report confirming migration completeness. No file modifications expected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-skill-migration/11-RESEARCH.md
@.planning/phases/11-skill-migration/11-01-SUMMARY.md
@.planning/phases/11-skill-migration/11-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify no inline Dispatch code remains</name>
  <files></files>
  <action>
Run comprehensive verification across all skills to confirm:

1. **Check migrated skills use library:**
```bash
for skill in test-feature explore-app test-dynamic-type qa-feature; do
  echo "=== $skill ==="

  # Must have source line
  if grep -q "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/$skill/SKILL.md; then
    echo "OK: Sources shared library"
  else
    echo "FAIL: Missing source line"
  fi

  # Must have dispatch_init
  if grep -q "dispatch_init" ~/.claude/skills/$skill/SKILL.md; then
    echo "OK: Uses dispatch_init"
  else
    echo "FAIL: Missing dispatch_init"
  fi

  # Must have dispatch_finalize
  if grep -q "dispatch_finalize" ~/.claude/skills/$skill/SKILL.md; then
    echo "OK: Uses dispatch_finalize"
  else
    echo "FAIL: Missing dispatch_finalize"
  fi

  # Must NOT have inline curl commands
  if grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/$skill/SKILL.md; then
    echo "FAIL: Inline curl for /screenshots/run still present"
  else
    echo "OK: No inline /screenshots/run curl"
  fi

  if grep -q 'curl.*localhost:19847/screenshots/complete' ~/.claude/skills/$skill/SKILL.md; then
    echo "FAIL: Inline curl for /screenshots/complete still present"
  else
    echo "OK: No inline /screenshots/complete curl"
  fi

  echo ""
done
```

2. **Scan all skills for any remaining inline patterns:**
```bash
echo "=== Scanning ALL skills for remaining inline code ==="
for skill_dir in ~/.claude/skills/*/; do
  skill=$(basename "$skill_dir")
  skill_file="$skill_dir/SKILL.md"

  if [[ -f "$skill_file" ]]; then
    # Check for inline Dispatch API patterns that should be replaced
    if grep -q 'curl.*localhost:19847/screenshots/run' "$skill_file"; then
      echo "FOUND inline /screenshots/run in: $skill"
    fi
    if grep -q 'curl.*localhost:19847/screenshots/complete' "$skill_file"; then
      echo "FOUND inline /screenshots/complete in: $skill"
    fi
    if grep -q 'DISPATCH_RESPONSE.*curl.*POST' "$skill_file"; then
      echo "FOUND inline DISPATCH_RESPONSE pattern in: $skill"
    fi
  fi
done
echo "Scan complete"
```

3. **Document migration results:**
Report the following:
- Number of skills successfully migrated: 4
- Total lines of inline code removed: ~133 lines
- Replacement code: ~10-15 lines total (source + init + finalize per skill)
- Net code reduction: ~118 lines
  </action>
  <verify>
# All 4 skills should pass verification
PASS=0
for skill in test-feature explore-app test-dynamic-type qa-feature; do
  if grep -q "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/$skill/SKILL.md && \
     grep -q "dispatch_init" ~/.claude/skills/$skill/SKILL.md && \
     grep -q "dispatch_finalize" ~/.claude/skills/$skill/SKILL.md && \
     ! grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/$skill/SKILL.md; then
    PASS=$((PASS + 1))
  fi
done
echo "Skills passing verification: $PASS/4"
[ "$PASS" -eq 4 ]
  </verify>
  <done>All 4 skills verified: source library, use dispatch_init/dispatch_finalize, no inline curl commands</done>
</task>

<task type="auto">
  <name>Task 2: Generate migration summary</name>
  <files></files>
  <action>
Create a final migration summary documenting:

**Skills Migrated (4):**
| Skill | Pattern | Lines Removed | Status |
|-------|---------|---------------|--------|
| test-feature | Single-run | ~30 | Migrated |
| explore-app | Single-run | ~33 | Migrated |
| test-dynamic-type | Multi-run | ~40 | Migrated |
| qa-feature | Single-run | ~30 | Migrated |

**Total Impact:**
- Inline code removed: ~133 lines
- Library calls added: ~12 lines (3 per skill avg)
- Net reduction: ~121 lines
- Single source of truth: ~/.claude/lib/dispatch.sh

**Migration Pattern Used:**
```bash
# Before (inline)
DISPATCH_HEALTH=$(curl -s http://localhost:19847/health 2>/dev/null)
if echo "$DISPATCH_HEALTH" | grep -q '"status":"ok"'; then
  PROJECT_NAME=$(basename "$(pwd)")
  DISPATCH_RESPONSE=$(curl -s -X POST http://localhost:19847/screenshots/run ...)
  DISPATCH_RUN_ID=$(echo "$DISPATCH_RESPONSE" | grep -o '"runId":"[^"]*"' | cut -d'"' -f4)
  DISPATCH_SCREENSHOT_PATH=$(echo "$DISPATCH_RESPONSE" | grep -o '"path":"[^"]*"' | cut -d'"' -f4 | tr -d '\\')
  # ... 20+ more lines ...
fi

# After (library)
source ~/.claude/lib/dispatch.sh
dispatch_init "Run Name" "$DEVICE_INFO"
# ... screenshots ...
dispatch_finalize
```

**Benefits Achieved:**
1. DRY principle: Integration logic in one place
2. Bug fixes propagate automatically
3. Consistent behavior across all skills
4. Easier maintenance and updates
5. Better error handling (library-level)
  </action>
  <verify>echo "Migration summary generated"</verify>
  <done>Migration summary documenting all changes and benefits created</done>
</task>

</tasks>

<verification>
```bash
# Final comprehensive check
echo "=== FINAL MIGRATION VERIFICATION ==="
echo ""

TOTAL=0
PASSED=0

for skill in test-feature explore-app test-dynamic-type qa-feature; do
  TOTAL=$((TOTAL + 1))

  HAS_SOURCE=$(grep -c "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/$skill/SKILL.md 2>/dev/null || echo 0)
  HAS_INIT=$(grep -c "dispatch_init" ~/.claude/skills/$skill/SKILL.md 2>/dev/null || echo 0)
  HAS_FINAL=$(grep -c "dispatch_finalize" ~/.claude/skills/$skill/SKILL.md 2>/dev/null || echo 0)
  HAS_INLINE=$(grep -c 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/$skill/SKILL.md 2>/dev/null || echo 0)

  if [[ "$HAS_SOURCE" -gt 0 && "$HAS_INIT" -gt 0 && "$HAS_FINAL" -gt 0 && "$HAS_INLINE" -eq 0 ]]; then
    echo "PASS: $skill"
    PASSED=$((PASSED + 1))
  else
    echo "FAIL: $skill (source=$HAS_SOURCE, init=$HAS_INIT, final=$HAS_FINAL, inline=$HAS_INLINE)"
  fi
done

echo ""
echo "Results: $PASSED/$TOTAL skills successfully migrated"
echo ""

if [[ "$PASSED" -eq "$TOTAL" ]]; then
  echo "PHASE 11 MIGRATION COMPLETE"
else
  echo "MIGRATION INCOMPLETE - review failed skills"
fi
```
</verification>

<success_criteria>
- All 4 migrated skills pass verification checks
- No inline Dispatch integration code found in any skill
- Migration summary documents the complete transformation
- Phase 11 requirements SKILL-01 through SKILL-06 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-skill-migration/11-03-SUMMARY.md`
</output>
