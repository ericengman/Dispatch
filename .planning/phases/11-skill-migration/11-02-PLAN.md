---
phase: 11-skill-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/skills/test-dynamic-type/SKILL.md
autonomous: true

must_haves:
  truths:
    - "test-dynamic-type skill sources shared library instead of inline code"
    - "Skill creates separate Dispatch runs for each text size tested"
    - "Each size run is properly finalized before starting the next"
    - "Multi-run pattern works correctly with the library"
  artifacts:
    - path: "~/.claude/skills/test-dynamic-type/SKILL.md"
      provides: "Migrated test-dynamic-type skill with multi-run pattern"
      contains: "source ~/.claude/lib/dispatch.sh"
  key_links:
    - from: "~/.claude/skills/test-dynamic-type/SKILL.md"
      to: "~/.claude/lib/dispatch.sh"
      via: "bash source command in loop"
      pattern: "dispatch_init.*SIZE_NAME"
---

<objective>
Migrate test-dynamic-type skill from inline Dispatch integration code to sourcing the shared library, preserving the multi-run pattern (one run per text size).

Purpose: Replace ~40 lines of duplicated inline bash code with clean library sourcing while maintaining the skill's unique multi-run behavior (creating separate Dispatch runs for small, default, and large text sizes).

Output: Updated SKILL.md file using `source ~/.claude/lib/dispatch.sh` with `dispatch_init` and `dispatch_finalize` called in a loop for each text size.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-skill-migration/11-RESEARCH.md
@~/.claude/lib/dispatch.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test-dynamic-type skill with multi-run pattern</name>
  <files>~/.claude/skills/test-dynamic-type/SKILL.md</files>
  <action>
Replace inline Dispatch integration code with shared library sourcing, preserving the multi-run pattern.

**Phase 1.3 initial check (around lines 124-143):**
Replace the inline health check with library sourcing:
```bash
# Source Dispatch library
source ~/.claude/lib/dispatch.sh

# Check if Dispatch is available (library sets DISPATCH_AVAILABLE after init)
# We'll check availability when creating runs for each size
PROJECT_NAME=$(basename "$(pwd)")
DEVICE_INFO=$(xcrun simctl list devices booted | grep -m1 "iPhone\|iPad" | sed 's/.*(\([^)]*\)).*/\1/' | xargs)

echo "Testing with Dispatch integration via shared library"
```

**Phase 2 per-size run creation (around lines 160-183):**
Replace the inline curl/grep/cut per-size block with:
```bash
# SIZE_NAME is "small", "default", or "large"
# SIMCTL_SIZE is the actual simctl value

# Create Dispatch run for this size
dispatch_init "Dynamic Type Test - $SIZE_NAME" "$DEVICE_INFO"

# DISPATCH_SCREENSHOT_PATH is now set (or fallback if Dispatch unavailable)
echo "Screenshots for $SIZE_NAME size: $DISPATCH_SCREENSHOT_PATH"
```

Note: Since dispatch_init creates a state file each time, and dispatch_finalize cleans it up, calling them in a loop works correctly. Each iteration gets its own run.

**Phase 3.3 per-size completion (around lines 265-274):**
Replace the inline curl completion with:
```bash
# Complete this size's run
dispatch_finalize
echo "Completed $SIZE_NAME size run"
```

**Update documentation sections:**
- Update "Dispatch Screenshot Integration" section to show library-based multi-run pattern
- Remove verbose API endpoint documentation
- Show the loop pattern clearly:
```bash
source ~/.claude/lib/dispatch.sh

for SIZE_NAME in small default large; do
    dispatch_init "Dynamic Type Test - $SIZE_NAME" "$DEVICE_INFO"

    # Take screenshots at this size...
    xcrun simctl ui "$SIM_ID" appearance contentSize $SIMCTL_SIZE
    # ... navigation and screenshots ...

    dispatch_finalize
done
```
  </action>
  <verify>
grep -q "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/test-dynamic-type/SKILL.md &&
grep -q "dispatch_init.*SIZE_NAME\|dispatch_init.*size" ~/.claude/skills/test-dynamic-type/SKILL.md &&
grep -q "dispatch_finalize" ~/.claude/skills/test-dynamic-type/SKILL.md &&
! grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/test-dynamic-type/SKILL.md
  </verify>
  <done>test-dynamic-type skill sources shared library and uses dispatch_init/dispatch_finalize in a loop for each text size</done>
</task>

</tasks>

<verification>
```bash
echo "=== test-dynamic-type ==="
grep -n "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/test-dynamic-type/SKILL.md || echo "MISSING: source line"

# Check for multi-run pattern (dispatch_init with size reference)
grep -n "dispatch_init" ~/.claude/skills/test-dynamic-type/SKILL.md | head -3 || echo "MISSING: dispatch_init"
grep -n "dispatch_finalize" ~/.claude/skills/test-dynamic-type/SKILL.md | head -3 || echo "MISSING: dispatch_finalize"

# Verify no inline curl commands remain
if grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/test-dynamic-type/SKILL.md; then
  echo "ERROR: Inline curl commands still present"
else
  echo "OK: No inline curl commands"
fi

# Verify the loop pattern documentation exists
grep -n "for SIZE_NAME\|for size" ~/.claude/skills/test-dynamic-type/SKILL.md | head -1 || echo "Note: May need to check loop pattern"
```
</verification>

<success_criteria>
- test-dynamic-type skill sources ~/.claude/lib/dispatch.sh
- Skill uses dispatch_init() with size-specific run names
- Skill uses dispatch_finalize() to complete each size's run
- Multi-run pattern is preserved (one run per text size)
- No inline curl commands for /screenshots/run or /screenshots/complete remain
- Documentation shows the correct loop pattern for multi-run testing
</success_criteria>

<output>
After completion, create `.planning/phases/11-skill-migration/11-02-SUMMARY.md`
</output>
