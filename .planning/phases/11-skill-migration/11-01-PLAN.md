---
phase: 11-skill-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/skills/test-feature/SKILL.md
  - ~/.claude/skills/explore-app/SKILL.md
  - ~/.claude/skills/qa-feature/SKILL.md
autonomous: true

must_haves:
  truths:
    - "test-feature skill sources shared library instead of inline code"
    - "explore-app skill sources shared library instead of inline code"
    - "qa-feature skill sources shared library instead of inline code"
    - "All three skills use dispatch_init and dispatch_finalize functions"
  artifacts:
    - path: "~/.claude/skills/test-feature/SKILL.md"
      provides: "Migrated test-feature skill"
      contains: "source ~/.claude/lib/dispatch.sh"
    - path: "~/.claude/skills/explore-app/SKILL.md"
      provides: "Migrated explore-app skill"
      contains: "source ~/.claude/lib/dispatch.sh"
    - path: "~/.claude/skills/qa-feature/SKILL.md"
      provides: "Migrated qa-feature skill"
      contains: "source ~/.claude/lib/dispatch.sh"
  key_links:
    - from: "All three skill files"
      to: "~/.claude/lib/dispatch.sh"
      via: "bash source command"
      pattern: "source ~/.claude/lib/dispatch.sh"
---

<objective>
Migrate single-run pattern skills (test-feature, explore-app, qa-feature) from inline Dispatch integration code to sourcing the shared library.

Purpose: Replace ~93 lines of duplicated inline bash code across three skills with clean library sourcing, establishing the shared library as the single source of truth for Dispatch integration.

Output: Three updated SKILL.md files using `source ~/.claude/lib/dispatch.sh` with `dispatch_init` and `dispatch_finalize` function calls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-skill-migration/11-RESEARCH.md
@~/.claude/lib/dispatch.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test-feature skill</name>
  <files>~/.claude/skills/test-feature/SKILL.md</files>
  <action>
Replace inline Dispatch integration code with shared library sourcing.

**Phase 2 initialization (around lines 195-223):**
Replace the inline curl/grep/cut block with:
```bash
# Initialize Dispatch Screenshot Run (if available)
source ~/.claude/lib/dispatch.sh

PROJECT_NAME=$(basename "$(pwd)")
DEVICE_INFO=$(xcrun simctl list devices booted | grep -m1 "iPhone\|iPad" | sed 's/.*(\([^)]*\)).*/\1/' | xargs)

dispatch_init "Feature Test" "$DEVICE_INFO"

# State is now available via:
# - $DISPATCH_SCREENSHOT_PATH: Where to save screenshots
# - $DISPATCH_RUN_ID: Run UUID (if Dispatch available)
# - $DISPATCH_AVAILABLE: true/false
```

**Phase 8 finalization (around lines 386-393):**
Replace the inline curl completion block with:
```bash
# Complete Dispatch Screenshot Run
dispatch_finalize
```

**Update documentation sections:**
- Update "Dispatch Screenshot Integration" section to reference the shared library
- Remove detailed inline API documentation (library handles this)
- Keep high-level description of how screenshots are organized
  </action>
  <verify>
grep -q "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/test-feature/SKILL.md &&
grep -q "dispatch_init" ~/.claude/skills/test-feature/SKILL.md &&
grep -q "dispatch_finalize" ~/.claude/skills/test-feature/SKILL.md &&
! grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/test-feature/SKILL.md
  </verify>
  <done>test-feature skill sources shared library and uses dispatch_init/dispatch_finalize instead of inline curl commands</done>
</task>

<task type="auto">
  <name>Task 2: Migrate explore-app skill</name>
  <files>~/.claude/skills/explore-app/SKILL.md</files>
  <action>
Replace inline Dispatch integration code with shared library sourcing.

**Phase 1 initialization (around lines 139-168):**
Replace the inline curl/grep/cut block with:
```bash
# Initialize Dispatch Screenshot Run (if available)
source ~/.claude/lib/dispatch.sh

PROJECT_NAME=$(basename "$(pwd)")
DEVICE_INFO=$(xcrun simctl list devices booted | grep -m1 "iPhone\|iPad" | sed 's/.*(\([^)]*\)).*/\1/' | xargs)

dispatch_init "App Exploration" "$DEVICE_INFO"

# State is now available via:
# - $DISPATCH_SCREENSHOT_PATH: Where to save screenshots
# - $DISPATCH_RUN_ID: Run UUID (if Dispatch available)
# - $DISPATCH_AVAILABLE: true/false
```

**Phase 8 cleanup (around lines 370-379):**
Replace the inline curl completion block with:
```bash
# Complete Dispatch Screenshot Run
dispatch_finalize
```

**Update documentation sections:**
- Update "Dispatch Screenshot Integration" section to reference the shared library
- Remove detailed inline API documentation (library handles this)
- Keep high-level description of how screenshots are organized
  </action>
  <verify>
grep -q "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/explore-app/SKILL.md &&
grep -q "dispatch_init" ~/.claude/skills/explore-app/SKILL.md &&
grep -q "dispatch_finalize" ~/.claude/skills/explore-app/SKILL.md &&
! grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/explore-app/SKILL.md
  </verify>
  <done>explore-app skill sources shared library and uses dispatch_init/dispatch_finalize instead of inline curl commands</done>
</task>

<task type="auto">
  <name>Task 3: Migrate qa-feature skill</name>
  <files>~/.claude/skills/qa-feature/SKILL.md</files>
  <action>
Replace inline Dispatch integration code with shared library sourcing.

**Phase 1 initialization (around lines 235-260):**
Replace the inline curl/grep/cut block with:
```bash
# Initialize Dispatch Screenshot Run (if available)
source ~/.claude/lib/dispatch.sh

PROJECT_NAME=$(basename "$(pwd)")
FEATURE_NAME="$1"  # From skill parameter

dispatch_init "QA: $FEATURE_NAME" "iPhone 15 Pro"

# State is now available via:
# - $DISPATCH_SCREENSHOT_PATH: Where to save screenshots
# - $DISPATCH_RUN_ID: Run UUID (if Dispatch available)
# - $DISPATCH_AVAILABLE: true/false
```

**Phase 6 completion (around lines 699-707):**
Replace the inline curl completion block with:
```bash
# Complete Dispatch Screenshot Run
dispatch_finalize
```

**Update documentation sections:**
- Remove "Screenshot Path Rule" verbose API details (library handles this)
- Keep the rule about using $DISPATCH_SCREENSHOT_PATH for all screenshots
- Simplify initialization documentation to show library usage
  </action>
  <verify>
grep -q "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/qa-feature/SKILL.md &&
grep -q "dispatch_init" ~/.claude/skills/qa-feature/SKILL.md &&
grep -q "dispatch_finalize" ~/.claude/skills/qa-feature/SKILL.md &&
! grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/qa-feature/SKILL.md
  </verify>
  <done>qa-feature skill sources shared library and uses dispatch_init/dispatch_finalize instead of inline curl commands</done>
</task>

</tasks>

<verification>
```bash
# Verify all three skills source the library
for skill in test-feature explore-app qa-feature; do
  echo "=== $skill ==="
  grep -n "source ~/.claude/lib/dispatch.sh" ~/.claude/skills/$skill/SKILL.md || echo "MISSING: source line"
  grep -n "dispatch_init" ~/.claude/skills/$skill/SKILL.md | head -1 || echo "MISSING: dispatch_init"
  grep -n "dispatch_finalize" ~/.claude/skills/$skill/SKILL.md | head -1 || echo "MISSING: dispatch_finalize"

  # Verify no inline curl commands remain
  if grep -q 'curl.*localhost:19847/screenshots/run' ~/.claude/skills/$skill/SKILL.md; then
    echo "ERROR: Inline curl commands still present"
  else
    echo "OK: No inline curl commands"
  fi
  echo ""
done
```
</verification>

<success_criteria>
- All three skills (test-feature, explore-app, qa-feature) source ~/.claude/lib/dispatch.sh
- All three skills use dispatch_init() for run initialization
- All three skills use dispatch_finalize() for run completion
- No inline curl commands for /screenshots/run or /screenshots/complete remain
- Documentation updated to reference shared library pattern
</success_criteria>

<output>
After completion, create `.planning/phases/11-skill-migration/11-01-SUMMARY.md`
</output>
