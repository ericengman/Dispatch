---
phase: 26-sidebar-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Services/QuickCaptureManager.swift
  - Dispatch/Services/ThumbnailCache.swift
  - Dispatch/Views/Sidebar/QuickCaptureSidebarSection.swift
  - Dispatch/Views/Sidebar/QuickCaptureThumbnailCell.swift
  - Dispatch/Views/Sidebar/SidebarView.swift
  - Dispatch/Services/CaptureCoordinator.swift
autonomous: true

must_haves:
  truths:
    - "Quick Capture section appears in sidebar with Region and Window buttons"
    - "Recent captures strip shows last 3-5 captures as clickable thumbnails"
    - "Clicking a recent capture opens it in annotation UI"
    - "User can re-capture windows from MRU list"
  artifacts:
    - path: "Dispatch/Services/QuickCaptureManager.swift"
      provides: "MRU list management with persistence"
      exports: ["QuickCaptureManager"]
    - path: "Dispatch/Services/ThumbnailCache.swift"
      provides: "Fast thumbnail generation with CGImageSource"
      exports: ["ThumbnailCache"]
    - path: "Dispatch/Views/Sidebar/QuickCaptureSidebarSection.swift"
      provides: "Collapsible sidebar section with capture buttons and thumbnail grid"
      min_lines: 50
    - path: "Dispatch/Views/Sidebar/QuickCaptureThumbnailCell.swift"
      provides: "Individual thumbnail cell with hover re-capture action"
      min_lines: 40
  key_links:
    - from: "QuickCaptureSidebarSection.swift"
      to: "QuickCaptureManager.recentCaptures"
      via: "@ObservedObject binding"
      pattern: "captureManager\\.recentCaptures"
    - from: "QuickCaptureThumbnailCell.swift"
      to: "ThumbnailCache.shared.thumbnail"
      via: "async thumbnail loading"
      pattern: "ThumbnailCache\\.shared\\.thumbnail"
    - from: "CaptureCoordinator.handleCaptureResult"
      to: "QuickCaptureManager.addRecent"
      via: "MRU tracking on capture"
      pattern: "QuickCaptureManager\\.shared\\.addRecent"
---

<objective>
Add Quick Capture section to sidebar with capture action buttons and recent captures thumbnail strip.

Purpose: Provide quick access to capture functionality and recent captures directly from the sidebar, enabling faster capture workflows without navigating menus.

Output:
- QuickCaptureManager service for MRU list persistence
- ThumbnailCache actor for fast thumbnail generation
- Quick Capture sidebar section with Region/Window buttons
- Recent captures grid with clickable thumbnails and re-capture action
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-sidebar-integration/26-RESEARCH.md

# Prior phase provides capture infrastructure
@Dispatch/Models/QuickCapture.swift
@Dispatch/Services/CaptureCoordinator.swift
@Dispatch/Services/ScreenshotCaptureService.swift
@Dispatch/Views/Sidebar/SidebarView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: QuickCaptureManager and ThumbnailCache Services</name>
  <files>
    Dispatch/Services/QuickCaptureManager.swift
    Dispatch/Services/ThumbnailCache.swift
  </files>
  <action>
Create QuickCaptureManager as @MainActor ObservableObject:
- @Published recentCaptures: [QuickCapture] array
- maxRecent = 5 for MRU limit
- addRecent(_:) - inserts at front, deduplicates by id, trims to max
- removeRecent(id:) - removes specific capture
- clearRecent() - clears all
- Persist to UserDefaults with key "recentQuickCaptures"
- On init, load from UserDefaults and filter out captures with missing files
- Singleton pattern: static let shared = QuickCaptureManager()

Create ThumbnailCache as actor:
- Use NSCache<NSString, NSImage> with countLimit 50 and totalCostLimit 10MB
- thumbnail(for: QuickCapture) async -> NSImage? method
- Check cache first by filePath key
- Generate using CGImageSourceCreateWithURL with options:
  - kCGImageSourceCreateThumbnailFromImageAlways: true
  - kCGImageSourceCreateThumbnailWithTransform: true
  - kCGImageSourceThumbnailMaxPixelSize: 120
- Cache with cost = width * height * 4 (estimated bytes)
- Return nil gracefully if file doesn't exist

Use AppKit and Foundation. NO SwiftUI needed in these services.
  </action>
  <verify>
Build succeeds with no errors. Run: xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -20
  </verify>
  <done>
QuickCaptureManager persists MRU list to UserDefaults and provides reactive updates.
ThumbnailCache generates fast thumbnails using CGImageSource with proper caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Quick Capture Sidebar Section with Thumbnails</name>
  <files>
    Dispatch/Views/Sidebar/QuickCaptureSidebarSection.swift
    Dispatch/Views/Sidebar/QuickCaptureThumbnailCell.swift
    Dispatch/Views/Sidebar/SidebarView.swift
    Dispatch/Services/CaptureCoordinator.swift
  </files>
  <action>
Create QuickCaptureThumbnailCell view:
- Takes QuickCapture, onSelect closure, onRecapture closure
- @State thumbnail: NSImage? for async loaded thumbnail
- VStack with:
  - Thumbnail image (80x60, RoundedRectangle clip, aspect fill)
  - Placeholder with ProgressView while loading
  - Relative timestamp caption (use RelativeDateTimeFormatter)
- Hover overlay with re-capture button (arrow.clockwise icon) at top-right
- onAppear: Task.detached to load thumbnail via ThumbnailCache.shared
- contentShape(Rectangle()) for tap gesture
- onTapGesture calls onSelect

Create QuickCaptureSidebarSection view:
- @ObservedObject captureManager = QuickCaptureManager.shared
- @Environment(\.openWindow) for opening annotation windows
- Section header with:
  - Label("Quick Capture", systemImage: "camera")
  - Spacer
  - HStack of buttons: viewfinder.rectangular (region), macwindow (window)
  - Buttons use .buttonStyle(.borderless) and .help() tooltips
- Section content:
  - If recentCaptures.isEmpty: Empty state with icon + text
  - Else: ScrollView(.horizontal) with LazyHGrid of QuickCaptureThumbnailCell
  - Grid uses GridItem(.fixed(80)) for row height
  - onSelect: openWindow(value: capture)
  - onRecapture: trigger WindowCaptureSession and handle result

Add capture trigger methods:
- triggerRegionCapture(): await ScreenshotCaptureService.shared.captureRegion() then handleResult
- triggerWindowCapture(): await WindowCaptureSession().start() then handleResult

Update SidebarView.swift:
- Add quickCaptureSection as first Section before Projects
- Place it at top of the List

Update CaptureCoordinator.handleCaptureResult:
- After creating QuickCapture on success, call QuickCaptureManager.shared.addRecent(capture)
- This ensures captures from menu AND sidebar both update MRU list
  </action>
  <verify>
Build and run the app. Verify:
1. Quick Capture section appears at top of sidebar with two icon buttons
2. Region button triggers cross-hair capture
3. Window button triggers window selection mode
4. After capture, thumbnail appears in recent captures strip
5. Clicking thumbnail opens annotation window
6. Hover shows re-capture button on thumbnail
  </verify>
  <done>
Quick Capture section in sidebar with Region/Window buttons and recent captures thumbnail strip.
Thumbnails load asynchronously with caching.
Clicking opens annotation UI, hover reveals re-capture action.
MRU list persists across app launches.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Build succeeds: xcodebuild -scheme Dispatch build
2. Region capture from sidebar works end-to-end
3. Window capture from sidebar works end-to-end
4. Recent captures persist after app restart
5. Thumbnails load quickly (CGImageSource performance)
6. Clicking thumbnail opens annotation window
7. Re-capture button visible on hover
</verification>

<success_criteria>
- Quick Capture section is first section in sidebar
- Region and Window capture buttons work from sidebar
- Recent captures strip shows 3-5 thumbnails in horizontal scroll
- Thumbnails load asynchronously without blocking UI
- Clicking thumbnail opens annotation window for that capture
- Re-capture action available on hover
- MRU list persists to UserDefaults
- Requirements satisfied: UI-01, UI-04, CAPT-04
</success_criteria>

<output>
After completion, create `.planning/phases/26-sidebar-integration/26-01-SUMMARY.md`
</output>
