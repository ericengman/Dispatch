---
phase: 19-session-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Models/TerminalSession.swift
  - Dispatch/Models/Project.swift
  - Dispatch/Services/TerminalSessionManager.swift
  - Dispatch/DispatchApp.swift
autonomous: true

must_haves:
  truths:
    - "TerminalSession is persisted to SwiftData database"
    - "Sessions maintain relationship with Projects via path matching"
    - "Runtime references (coordinator, terminal) are stored in manager, not model"
  artifacts:
    - path: "Dispatch/Models/TerminalSession.swift"
      provides: "@Model TerminalSession with SwiftData persistence"
      contains: "@Model"
    - path: "Dispatch/Models/Project.swift"
      provides: "sessions relationship on Project"
      contains: "var sessions:"
    - path: "Dispatch/Services/TerminalSessionManager.swift"
      provides: "Runtime ref dictionaries and ModelContext integration"
      contains: "coordinators:"
  key_links:
    - from: "Dispatch/Models/TerminalSession.swift"
      to: "Dispatch/Models/Project.swift"
      via: "@Relationship inverse"
      pattern: "inverse:.*TerminalSession"
    - from: "Dispatch/Services/TerminalSessionManager.swift"
      to: "ModelContext"
      via: "configure method"
      pattern: "modelContext.*insert"
---

<objective>
Convert TerminalSession from @Observable to SwiftData @Model with Project relationship

Purpose: Enable session persistence across app restarts by storing session metadata in SwiftData. This is the foundation for PERS-01, PERS-02, and PERS-03.

Output: TerminalSession as @Model with Project relationship, TerminalSessionManager updated to store runtime refs separately and use ModelContext for persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-session-persistence/19-RESEARCH.md

# Existing code to modify
@Dispatch/Models/TerminalSession.swift
@Dispatch/Models/Project.swift
@Dispatch/Services/TerminalSessionManager.swift
@Dispatch/DispatchApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert TerminalSession to @Model and add Project relationship</name>
  <files>
    Dispatch/Models/TerminalSession.swift
    Dispatch/Models/Project.swift
  </files>
  <action>
Convert TerminalSession from @Observable to @Model:

1. In TerminalSession.swift:
   - Change `@Observable` to `@Model` macro
   - Import SwiftData
   - Remove `weak var coordinator: EmbeddedTerminalView.Coordinator?` (runtime ref, cannot persist)
   - Remove `weak var terminal: LocalProcessTerminalView?` (runtime ref, cannot persist)
   - Add `var lastActivity: Date` property (initialized to Date())
   - Add `var project: Project?` optional relationship
   - Remove computed `isReady` property (depends on coordinator which is removed)
   - Keep: id, name, createdAt, claudeSessionId, workingDirectory
   - Keep: launchMode computed property
   - Add `func updateActivity()` method that sets lastActivity = Date()
   - Add computed `var isResumable: Bool { claudeSessionId != nil }`
   - Add computed `var relativeLastActivity: String` using RelativeDateTimeFormatter

2. In Project.swift:
   - Add relationship property in the Relationships section:
     ```swift
     @Relationship(deleteRule: .nullify, inverse: \TerminalSession.project)
     var sessions: [TerminalSession] = []
     ```
   - Add computed `var sessionCount: Int { sessions.count }`

Note: The init methods should match existing patterns from Prompt.swift - all properties with defaults.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"`
  </verify>
  <done>
TerminalSession is @Model with lastActivity, project relationship. Project has inverse sessions relationship with nullify delete rule. No runtime refs in model.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TerminalSessionManager with runtime refs and ModelContext</name>
  <files>
    Dispatch/Services/TerminalSessionManager.swift
    Dispatch/DispatchApp.swift
  </files>
  <action>
Update TerminalSessionManager to store runtime references separately and integrate ModelContext:

1. In TerminalSessionManager.swift:
   - Add import SwiftData at top
   - Add private property: `private var modelContext: ModelContext?`
   - Add dictionaries for runtime refs:
     ```swift
     private(set) var coordinators: [UUID: EmbeddedTerminalView.Coordinator] = [:]
     private(set) var terminals: [UUID: LocalProcessTerminalView] = [:]
     ```
   - Add `func configure(modelContext: ModelContext)` to store context
   - Update `createSession(name:)` to:
     - Create TerminalSession (now @Model)
     - Insert into modelContext if available
     - Log whether persisted or in-memory only
   - Update `createResumeSession(claudeSession:)` to:
     - Create TerminalSession with claudeSessionId and workingDirectory from ClaudeCodeSession
     - Insert into modelContext if available
   - Update `closeSession(_:)` to:
     - Remove from coordinators/terminals dictionaries
     - Delete from modelContext if available (use modelContext?.delete(session))
   - Add helper methods:
     ```swift
     func setCoordinator(_ coordinator: EmbeddedTerminalView.Coordinator, for sessionId: UUID)
     func setTerminal(_ terminal: LocalProcessTerminalView, for sessionId: UUID)
     func coordinator(for sessionId: UUID) -> EmbeddedTerminalView.Coordinator?
     func terminal(for sessionId: UUID) -> LocalProcessTerminalView?
     ```
   - Add `func updateSessionActivity(_ sessionId: UUID)` that calls session.updateActivity()

2. In DispatchApp.swift:
   - Add TerminalSession.self to the schema array (after Screenshot.self):
     ```swift
     let schema = Schema([
         Prompt.self,
         Project.self,
         PromptHistory.self,
         PromptChain.self,
         ChainItem.self,
         QueueItem.self,
         AppSettings.self,
         SimulatorRun.self,
         Screenshot.self,
         TerminalSession.self  // Add this
     ])
     ```
   - In setupApp(), add configuration call:
     ```swift
     // Configure terminal session manager
     TerminalSessionManager.shared.configure(modelContext: sharedModelContainer.mainContext)
     ```
     Add this after SettingsManager.shared.configure() call.
  </action>
  <verify>
Build succeeds and app launches without crash: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build && open -F "$(find ~/Library/Developer/Xcode/DerivedData -name 'Dispatch.app' -path '*Build/Products/Debug*' 2>/dev/null | head -1)"`
  </verify>
  <done>
TerminalSessionManager stores runtime refs in separate dictionaries. ModelContext configured on app launch. Sessions inserted/deleted via modelContext.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update EmbeddedTerminalView to use manager for runtime refs</name>
  <files>
    Dispatch/Views/Terminal/EmbeddedTerminalView.swift
    Dispatch/Views/Terminal/SessionPaneView.swift
  </files>
  <action>
Update views to store runtime refs in TerminalSessionManager instead of TerminalSession model:

1. In EmbeddedTerminalView.swift:
   - In makeNSView(), where it currently sets `session.coordinator` and `session.terminal`:
     - Replace with calls to TerminalSessionManager:
       ```swift
       // Instead of: session.coordinator = context.coordinator
       // Use: TerminalSessionManager.shared.setCoordinator(context.coordinator, for: sessionId)
       TerminalSessionManager.shared.setCoordinator(context.coordinator, for: sessionId)
       TerminalSessionManager.shared.setTerminal(terminal, for: sessionId)
       ```
   - Remove the lines that set session.coordinator and session.terminal directly

2. In SessionPaneView.swift (if it accesses session.coordinator or session.terminal):
   - Update any direct access to use manager:
     ```swift
     // Instead of: session.coordinator?.dispatchPrompt(...)
     // Use: TerminalSessionManager.shared.coordinator(for: session.id)?.dispatchPrompt(...)
     ```

3. Check MultiSessionTerminalView.swift for any direct session.coordinator/terminal access:
   - If found, update to use manager lookup pattern

4. Update EmbeddedTerminalView Coordinator deinit:
   - Instead of clearing session refs, clear from manager:
     ```swift
     // In deinit, after unregister from bridge:
     MainActor.assumeIsolated {
         if let sessionId = sessionId {
             // No longer need to clear session refs - they're in manager
             // Manager cleanup happens in closeSession()
         }
     }
     ```

Note: The closeSession() method in TerminalSessionManager already handles cleanup of coordinators/terminals dictionaries.
  </action>
  <verify>
Build succeeds and creating/closing sessions works: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | grep -E "(error:|BUILD SUCCEEDED)"`
  </verify>
  <done>
Runtime refs stored in TerminalSessionManager dictionaries. TerminalSession @Model no longer has coordinator/terminal properties. View layer uses manager for lookups.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. App launches without crash
3. Can create new terminal session (button in SessionTabBar)
4. Session appears in tab bar
5. Closing session removes it from tab bar
6. Check SwiftData storage: `sqlite3 ~/Library/Application\ Support/Dispatch/default.store "SELECT * FROM ZTERMINALSESSION;"`
</verification>

<success_criteria>
- TerminalSession is @Model, not @Observable
- Project has sessions relationship with inverse
- TerminalSessionManager stores coordinator/terminal in dictionaries
- Sessions are inserted into ModelContext on creation
- Sessions are deleted from ModelContext on close
- App builds and runs without crash
</success_criteria>

<output>
After completion, create `.planning/phases/19-session-persistence/19-01-SUMMARY.md`
</output>
