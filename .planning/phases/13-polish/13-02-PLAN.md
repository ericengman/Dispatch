---
phase: 13-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Views/Simulator/AnnotationToolbar.swift
  - Dispatch/Views/Simulator/AnnotationWindow.swift
autonomous: false

must_haves:
  truths:
    - "All annotation tools show descriptive tooltip on hover"
    - "All color buttons show tooltip with color name and shortcut"
    - "Failed dispatch shows alert dialog with error message"
    - "Dispatch section shows integration status (green/orange/red)"
  artifacts:
    - path: "Dispatch/Views/Simulator/AnnotationToolbar.swift"
      provides: "Enhanced tooltip text for tools and colors"
      contains: "tooltipText"
    - path: "Dispatch/Views/Simulator/AnnotationWindow.swift"
      provides: "Error alert and integration status indicator"
      contains: "showingDispatchError"
  key_links:
    - from: "AnnotationWindow.swift"
      to: "HookInstallerManager"
      via: "status.isInstalled check"
      pattern: "HookInstallerManager.shared.status"
    - from: "AnnotationWindow.swift"
      to: "TerminalServiceError"
      via: "catch block handling"
      pattern: "TerminalServiceError"
---

<objective>
Polish the annotation UI with descriptive tooltips, user-visible error messages, and integration status indicator.

Purpose: Improve discoverability of annotation tools (POLISH-02), make dispatch failures visible to users (POLISH-03), and show integration health (POLISH-04).
Output: Enhanced AnnotationToolbar with full tooltips, AnnotationWindow with error alerts and status indicator.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-polish/13-RESEARCH.md

# Key reference files
@Dispatch/Views/Simulator/AnnotationToolbar.swift
@Dispatch/Views/Simulator/AnnotationWindow.swift
@Dispatch/Services/HookInstaller.swift
@Dispatch/Services/TerminalService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance annotation tool tooltips</name>
  <files>Dispatch/Views/Simulator/AnnotationToolbar.swift</files>
  <action>
Enhance ToolButton to have more descriptive tooltips:

1. In ToolButton, replace the simple `.help()` with a computed property:
```swift
private var tooltipText: String {
    switch tool {
    case .crop:
        return "Crop image to selected region (C)"
    case .freehand:
        return "Draw freehand annotations (D)"
    case .arrow:
        return "Draw arrow to point at specific area (A)"
    case .rectangle:
        return "Draw rectangle to highlight region (R)"
    case .text:
        return "Add text annotation (T)"
    }
}
```

2. Update the `.help()` call to use `tooltipText`

3. ColorButton already has a good tooltip pattern. Enhance it slightly:
```swift
.help("\(color.rawValue.capitalized) color (\(color.shortcutNumber))")
```
(Add "color" word for clarity)

4. Verify all action buttons in actionsSection have descriptive `.help()`:
- Undo: Already has "Undo (Cmd+Z)" - keep as is
- Redo: Already has "Redo (Shift+Cmd+Z)" - keep as is
- Clear: Already has "Clear Annotations" - keep as is
- Zoom buttons: Already have tooltips - keep as is
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
  </verify>
  <done>
All annotation tools and colors show descriptive tooltips explaining their function and keyboard shortcut.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dispatch error alert and integration status</name>
  <files>Dispatch/Views/Simulator/AnnotationWindow.swift</files>
  <action>
Add user-visible error handling and integration status to AnnotationWindowContent:

1. Add state properties:
```swift
@State private var dispatchError: String?
@State private var showingDispatchError = false
@State private var libraryInstalled = false
@State private var hookInstalled = false
```

2. Add `.alert()` modifier to the main VStack in body:
```swift
.alert("Dispatch Failed", isPresented: $showingDispatchError) {
    Button("OK", role: .cancel) {
        dispatchError = nil
    }
    Button("Open Settings") {
        openTerminalSettings()
    }
} message: {
    Text(dispatchError ?? "Failed to send to Terminal. Check automation permissions.")
}
```

3. Update the `dispatch()` function to show errors:
- In the catch block for TerminalService errors, set `dispatchError` and `showingDispatchError = true`
- Handle specific error types with helpful messages:
  - `.permissionDenied`: "Terminal automation permission denied. Grant access in System Settings > Privacy & Security > Automation."
  - `.accessibilityPermissionDenied`: "Accessibility permission denied. Grant access in System Settings > Privacy & Security > Accessibility."
  - Other errors: Use error.localizedDescription
- For clipboard copy failure: "Failed to copy images to clipboard. Check available memory."

4. Add `openTerminalSettings()` helper:
```swift
private func openTerminalSettings() {
    if let url = URL(string: "x-apple.systempreferences:com.apple.preference.security?Privacy_Automation") {
        NSWorkspace.shared.open(url)
    }
}
```

5. Add integration status view to dispatchSection (before keyboard shortcut hint):
```swift
@ViewBuilder
private var integrationStatusView: some View {
    HStack(spacing: 4) {
        Image(systemName: statusIcon)
            .font(.caption2)
            .foregroundStyle(statusColor)
        Text(statusText)
            .font(.caption)
            .foregroundStyle(.secondary)
    }
}
```

6. Add computed properties for status:
```swift
private var statusIcon: String {
    switch (libraryInstalled, hookInstalled) {
    case (true, true): return "checkmark.circle.fill"
    case (true, false): return "exclamationmark.circle"
    case (false, _): return "xmark.circle"
    }
}

private var statusColor: Color {
    switch (libraryInstalled, hookInstalled) {
    case (true, true): return .green
    case (true, false): return .orange
    case (false, _): return .red
    }
}

private var statusText: String {
    switch (libraryInstalled, hookInstalled) {
    case (true, true): return "Integration ready"
    case (true, false): return "Library ready, hook inactive"
    case (false, _): return "Library not installed"
    }
}
```

7. Add status check function and call it in `.onAppear`:
```swift
private func checkIntegrationStatus() {
    Task {
        // Check library
        let libraryPath = FileManager.default.homeDirectoryForCurrentUser
            .appendingPathComponent(".claude/lib/dispatch.sh")
        let exists = FileManager.default.fileExists(atPath: libraryPath.path)
        if exists {
            let attributes = try? FileManager.default.attributesOfItem(atPath: libraryPath.path)
            let permissions = attributes?[.posixPermissions] as? Int ?? 0
            libraryInstalled = (permissions & 0o111) != 0
        } else {
            libraryInstalled = false
        }

        // Check hook
        await HookInstallerManager.shared.refreshStatus()
        hookInstalled = HookInstallerManager.shared.status.isInstalled
    }
}
```

8. Add `integrationStatusView` to dispatchSection, before the keyboard shortcut hint.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
  </verify>
  <done>
Dispatch section shows integration status indicator. Failed dispatch shows alert with error details and option to open Settings.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Annotation tooltips, dispatch error alerts, and integration status indicator</what-built>
  <how-to-verify>
1. Run the app and open annotation window with a screenshot run
2. **Tooltips**: Hover over each annotation tool (Crop, Draw, Arrow, Rectangle, Text) - verify descriptive tooltip appears
3. Hover over color buttons - verify tooltip shows color name and number
4. **Status indicator**: Check dispatch section shows status:
   - Green checkmark with "Integration ready" if library and hook installed
   - Orange exclamation with "Library ready, hook inactive" if only library
   - Red X with "Library not installed" if library missing
5. **Error handling**:
   - Quit Terminal.app
   - Try to dispatch - verify alert appears with error message
   - Verify "Open Settings" button opens System Settings
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Build succeeds without warnings
- [ ] All 5 tool buttons show descriptive tooltips
- [ ] All 7 color buttons show name and shortcut tooltips
- [ ] Integration status shows correctly based on library/hook state
- [ ] Dispatch failure shows alert dialog
- [ ] Alert has OK and Open Settings buttons
- [ ] Open Settings navigates to Automation preferences
</verification>

<success_criteria>
1. POLISH-02: All annotation tools have descriptive tooltips with shortcuts
2. POLISH-03: Dispatch failures show user-visible alert with actionable error message
3. POLISH-04: Integration status indicator shows library and hook status with color coding
</success_criteria>

<output>
After completion, create `.planning/phases/13-polish/13-02-SUMMARY.md`
</output>
