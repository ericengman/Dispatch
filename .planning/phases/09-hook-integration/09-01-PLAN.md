---
phase: 09-hook-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/hooks/session-start.sh
  - Docs/external-files/session-start-hook.md
autonomous: true

must_haves:
  truths:
    - "Claude Code session start outputs Dispatch availability status"
    - "DISPATCH_AVAILABLE environment variable is set in all bash commands after session start"
    - "DISPATCH_PORT environment variable is set when Dispatch is available"
    - "Hook sources dispatch.sh library and uses dispatch_check_health()"
  artifacts:
    - path: "~/.claude/hooks/session-start.sh"
      provides: "SessionStart hook for Dispatch detection"
      min_lines: 25
      contains: "dispatch_check_health"
    - path: "Docs/external-files/session-start-hook.md"
      provides: "Documentation for external hook file"
      contains: "CLAUDE_ENV_FILE"
  key_links:
    - from: "~/.claude/hooks/session-start.sh"
      to: "~/.claude/lib/dispatch.sh"
      via: "source command"
      pattern: "source.*dispatch\\.sh"
    - from: "~/.claude/hooks/session-start.sh"
      to: "CLAUDE_ENV_FILE"
      via: "export append"
      pattern: ">> .*CLAUDE_ENV_FILE"
---

<objective>
Create SessionStart hook that detects Dispatch availability at session start

Purpose: Early detection of Dispatch server enables skills to know upfront whether screenshot integration is available, eliminating per-command health check overhead and providing consistent session-wide state via CLAUDE_ENV_FILE.

Output:
- `~/.claude/hooks/session-start.sh` - Executable hook script
- `Docs/external-files/session-start-hook.md` - Documentation tracking external file
- HOOK-01, HOOK-02, HOOK-03 requirements complete
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hook-integration/09-RESEARCH.md
@.planning/phases/08-foundation/08-01-SUMMARY.md
@Docs/external-files/dispatch-lib.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session-start.sh hook</name>
  <files>~/.claude/hooks/session-start.sh</files>
  <action>
Create the SessionStart hook at ~/.claude/hooks/session-start.sh that:

1. Has proper shebang: `#!/bin/bash`

2. Checks if dispatch.sh library exists before sourcing:
   ```bash
   if [ ! -f ~/.claude/lib/dispatch.sh ]; then
       echo "Dispatch library not installed" >&2
       exit 0
   fi
   ```

3. Sources the library: `source ~/.claude/lib/dispatch.sh`

4. Performs health check using existing `dispatch_check_health` function

5. Writes to CLAUDE_ENV_FILE (only if variable is non-empty):
   - If Dispatch available:
     - `export DISPATCH_AVAILABLE=true`
     - `export DISPATCH_PORT=19847`
   - If Dispatch unavailable:
     - `export DISPATCH_AVAILABLE=false`
   - IMPORTANT: Use append `>>` not overwrite `>` to preserve other hooks' variables

6. Outputs status message:
   - stdout (for Claude context): Brief status like "Dispatch integration active" or "Dispatch not running"
   - stderr (for user): More detailed status message

7. Always exits 0 (hook failure should not block session)

8. Set executable permissions: `chmod 755 ~/.claude/hooks/session-start.sh`

Key patterns from research:
- Check `[ -n "$CLAUDE_ENV_FILE" ]` before writing
- Use `>>` to append, never `>` to overwrite
- Keep hook simple - complexity belongs in library
- stdout becomes Claude context, stderr goes to user
  </action>
  <verify>
Test hook directly:
```bash
chmod 755 ~/.claude/hooks/session-start.sh
export CLAUDE_ENV_FILE=$(mktemp)
~/.claude/hooks/session-start.sh
echo "Env file contents:"
cat $CLAUDE_ENV_FILE
rm $CLAUDE_ENV_FILE
```

Expected: DISPATCH_AVAILABLE=true/false in env file, status message to stderr
  </verify>
  <done>
- Hook file exists at ~/.claude/hooks/session-start.sh
- Hook is executable (755 permissions)
- Running hook sets DISPATCH_AVAILABLE in CLAUDE_ENV_FILE
- Hook sources dispatch.sh library
- Hook outputs status message to stdout for Claude context
  </done>
</task>

<task type="auto">
  <name>Task 2: Create hook documentation</name>
  <files>Docs/external-files/session-start-hook.md</files>
  <action>
Create documentation following the pattern established in Phase 8 for external files.

Document:
1. Purpose: SessionStart hook for Dispatch availability detection
2. Location: ~/.claude/hooks/session-start.sh
3. Trigger: Claude Code session start, resume, clear, compact events
4. Environment variables set:
   - DISPATCH_AVAILABLE (true/false)
   - DISPATCH_PORT (19847 when available)
5. Dependencies: ~/.claude/lib/dispatch.sh (Phase 8)
6. Output modes:
   - stdout: Context for Claude to see
   - stderr: Messages for user
7. How to test manually
8. Relationship to HookInstaller.swift (Phase 10 will auto-install)

Include code snippets showing how skills can use the environment variables:
```bash
if [ "$DISPATCH_AVAILABLE" = "true" ]; then
    source ~/.claude/lib/dispatch.sh
    dispatch_init "My Test" "iPhone 15 Pro"
fi
```
  </action>
  <verify>
```bash
cat Docs/external-files/session-start-hook.md | head -50
```
Verify documentation exists and covers key points.
  </verify>
  <done>
- Documentation file exists at Docs/external-files/session-start-hook.md
- Documents location, purpose, and environment variables
- Includes usage examples for skills
- References Phase 8 dispatch.sh library
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify hook integration</name>
  <files>Docs/external-files/session-start-hook.md</files>
  <action>
Perform integration verification:

1. Verify hook structure:
   - Shebang is `#!/bin/bash`
   - Library source with existence check
   - CLAUDE_ENV_FILE check before write
   - Append `>>` not overwrite `>`
   - Exit 0 always

2. Test with Dispatch running:
   ```bash
   export CLAUDE_ENV_FILE=$(mktemp)
   ~/.claude/hooks/session-start.sh 2>&1
   cat $CLAUDE_ENV_FILE
   # Expected: DISPATCH_AVAILABLE=true and DISPATCH_PORT=19847
   rm $CLAUDE_ENV_FILE
   ```

3. Test with Dispatch not running (stop Dispatch first if needed, or test on different port):
   ```bash
   # Temporarily modify port in test or stop Dispatch
   export CLAUDE_ENV_FILE=$(mktemp)
   ~/.claude/hooks/session-start.sh 2>&1
   cat $CLAUDE_ENV_FILE
   # Expected: DISPATCH_AVAILABLE=false
   rm $CLAUDE_ENV_FILE
   ```

4. Test without CLAUDE_ENV_FILE (simulates non-SessionStart context):
   ```bash
   unset CLAUDE_ENV_FILE
   ~/.claude/hooks/session-start.sh 2>&1
   # Expected: Still outputs status, no crash, exit 0
   ```

5. Verify coexistence with existing hooks:
   ```bash
   ls -la ~/.claude/hooks/
   # Confirm session-start.sh alongside existing hooks
   ```

6. Append verification results to documentation file with timestamp.
  </action>
  <verify>
All tests pass. Verification results appended to Docs/external-files/session-start-hook.md
  </verify>
  <done>
- Hook works with Dispatch running (DISPATCH_AVAILABLE=true)
- Hook works with Dispatch not running (DISPATCH_AVAILABLE=false)
- Hook works without CLAUDE_ENV_FILE (graceful degradation)
- Hook coexists with existing hooks in ~/.claude/hooks/
- Verification results documented
  </done>
</task>

</tasks>

<verification>
Phase verification checklist:

1. HOOK-01: SessionStart hook exists at ~/.claude/hooks/session-start.sh
   ```bash
   test -x ~/.claude/hooks/session-start.sh && echo "HOOK-01: PASS"
   ```

2. HOOK-02: Hook sets environment variables via CLAUDE_ENV_FILE
   ```bash
   export CLAUDE_ENV_FILE=$(mktemp)
   ~/.claude/hooks/session-start.sh >/dev/null 2>&1
   grep -q "DISPATCH_AVAILABLE" $CLAUDE_ENV_FILE && echo "HOOK-02: PASS"
   rm $CLAUDE_ENV_FILE
   ```

3. HOOK-03: Hook performs health check against Dispatch API
   ```bash
   grep -q "dispatch_check_health" ~/.claude/hooks/session-start.sh && echo "HOOK-03: PASS"
   ```
</verification>

<success_criteria>
- [ ] ~/.claude/hooks/session-start.sh exists and is executable
- [ ] Hook sources ~/.claude/lib/dispatch.sh
- [ ] Hook writes DISPATCH_AVAILABLE to CLAUDE_ENV_FILE
- [ ] Hook writes DISPATCH_PORT when Dispatch is available
- [ ] Hook outputs status to stdout for Claude context
- [ ] Hook always exits 0 (never blocks session)
- [ ] Documentation exists at Docs/external-files/session-start-hook.md
- [ ] All three HOOK requirements verified
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-integration/09-01-SUMMARY.md`
</output>
