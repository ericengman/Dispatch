---
phase: 10-dispatch-app-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Resources/dispatch-lib.sh
  - Dispatch/Resources/session-start-hook.sh
  - Dispatch/Services/HookInstaller.swift
  - Dispatch/DispatchApp.swift
  - Dispatch.xcodeproj/project.pbxproj
autonomous: true

must_haves:
  truths:
    - "Launching Dispatch creates ~/.claude/lib/dispatch.sh if it does not exist"
    - "Launching Dispatch creates ~/.claude/hooks/session-start.sh if it does not exist"
    - "Dispatch version upgrade updates library to match app version"
    - "Library and hook have executable permissions (0o755)"
  artifacts:
    - path: "Dispatch/Resources/dispatch-lib.sh"
      provides: "Bundled library content"
      min_lines: 200
    - path: "Dispatch/Resources/session-start-hook.sh"
      provides: "Bundled hook content"
      min_lines: 35
    - path: "Dispatch/Services/HookInstaller.swift"
      provides: "Library and hook installation logic"
      exports: ["installLibraryIfNeeded", "installSessionStartHookIfNeeded"]
  key_links:
    - from: "Dispatch/DispatchApp.swift"
      to: "HookInstallerManager.installLibraryIfNeeded()"
      via: "Task in setupApp()"
      pattern: "installLibraryIfNeeded"
    - from: "Dispatch/Services/HookInstaller.swift"
      to: "Bundle.main.url(forResource:)"
      via: "Resource loading"
      pattern: "Bundle\\.main\\.url.*forResource"
---

<objective>
Auto-install dispatch.sh library and session-start.sh hook when Dispatch app launches.

Purpose: Users get the latest library and hook automatically without manual installation. Version upgrades update files seamlessly.

Output: Dispatch app that auto-manages ~/.claude/lib/dispatch.sh and ~/.claude/hooks/session-start.sh on every launch.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-dispatch-app-updates/10-RESEARCH.md

# Existing implementation to extend
@Dispatch/Services/HookInstaller.swift
@Dispatch/DispatchApp.swift

# External files to bundle (for content reference)
# ~/.claude/lib/dispatch.sh (208 lines, version 1.0.0)
# ~/.claude/hooks/session-start.sh (42 lines)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bundle library and hook scripts as app resources</name>
  <files>
    Dispatch/Resources/dispatch-lib.sh
    Dispatch/Resources/session-start-hook.sh
    Dispatch.xcodeproj/project.pbxproj
  </files>
  <action>
    Create two new files in the Resources directory:

    1. `Dispatch/Resources/dispatch-lib.sh` - Copy content from `~/.claude/lib/dispatch.sh` (the library created in Phase 8). This is the canonical source that will be installed to user machines.

    2. `Dispatch/Resources/session-start-hook.sh` - Copy content from `~/.claude/hooks/session-start.sh` (the hook created in Phase 9). This is the canonical source that will be installed to user machines.

    Add both files to the Xcode project:
    - Add to "Copy Bundle Resources" build phase
    - File type should be "shell script" (or just text)
    - Add to Dispatch target only

    Use Xcode CLI to add files or edit project.pbxproj directly. Files must appear in Bundle.main at runtime.

    VERIFY: After adding, build the app and confirm files are in the built .app bundle:
    `find /path/to/build/Dispatch.app -name "*.sh" -type f`
  </action>
  <verify>
    Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build`
    Resources present: `find $(xcodebuild -scheme Dispatch -showBuildSettings | grep -m1 'BUILT_PRODUCTS_DIR' | awk '{print $3}')/Dispatch.app -name "*.sh" -type f | grep -E "(dispatch-lib|session-start)"`
  </verify>
  <done>
    - dispatch-lib.sh exists in Dispatch/Resources/ with ~208 lines
    - session-start-hook.sh exists in Dispatch/Resources/ with ~42 lines
    - Both files appear in Dispatch.app bundle after build
    - Both files are in "Copy Bundle Resources" build phase
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend HookInstaller with library and SessionStart hook installation</name>
  <files>Dispatch/Services/HookInstaller.swift</files>
  <action>
    Add new functionality to HookInstaller.swift:

    1. Add new error cases to HookInstallerError:
       - `.resourceNotFound(String)` - When bundled resource is missing
       - `.libraryInstallFailed(String)` - When library installation fails

    2. Add new properties to HookInstaller actor:
       - `libraryDirectory: URL` - Points to `~/.claude/lib/`
       - `libraryFileName = "dispatch.sh"`
       - `sessionStartHookFileName = "session-start.sh"`
       - `libraryVersionMarker = "DISPATCH_LIB_VERSION="`
       - `sessionStartMarker = "# session-start.sh - Detect Dispatch availability"`

    3. Add `installLibraryIfNeeded() throws` method to HookInstaller:
       - Load dispatch-lib.sh from Bundle.main.url(forResource: "dispatch-lib", withExtension: "sh")
       - Check if ~/.claude/lib/dispatch.sh exists
       - If exists, extract version from file (look for DISPATCH_LIB_VERSION="X.X.X")
       - Compare with app version from Bundle.main.infoDictionary?["CFBundleShortVersionString"]
       - If file missing OR version different: install (create directory, write atomically, chmod 755)
       - Log all actions via logInfo/logDebug

    4. Add `installSessionStartHookIfNeeded() throws` method to HookInstaller:
       - Load session-start-hook.sh from Bundle.main.url(forResource: "session-start-hook", withExtension: "sh")
       - Check if ~/.claude/hooks/session-start.sh exists
       - If exists, check for sessionStartMarker to confirm it's our hook
       - If file missing OR marker missing (not our hook): skip (don't overwrite user hooks)
       - If our hook exists, check for Dispatch version marker and update if outdated
       - Write atomically, chmod 755
       - Log all actions

    5. Add wrapper methods to HookInstallerManager (MainActor):
       - `installLibraryIfNeeded() async`
       - `installSessionStartHookIfNeeded() async`
       Both should catch errors, log them, but NOT rethrow (non-blocking).

    IMPORTANT patterns to follow (from existing code):
    - Use FileManager.default.homeDirectoryForCurrentUser (not hardcoded path)
    - Use createDirectory(withIntermediateDirectories: true)
    - Use String.write(to:atomically:encoding:) then setAttributes for chmod
    - Do NOT block on installation errors - log and continue

    Version comparison: Use String.compare(options: .numeric) for semantic version ordering.
  </action>
  <verify>
    Build succeeds with new methods.
    Unit test: Can call HookInstaller.shared.installLibraryIfNeeded() without crash.
  </verify>
  <done>
    - HookInstaller has installLibraryIfNeeded() method
    - HookInstaller has installSessionStartHookIfNeeded() method
    - HookInstallerManager has async wrapper methods
    - Error cases added for resource loading failures
    - Version checking compares DISPATCH_LIB_VERSION with app version
    - Permissions set to 0o755 after file write
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire installation to app launch</name>
  <files>Dispatch/DispatchApp.swift</files>
  <action>
    Modify setupApp() in DispatchApp.swift to call new installation methods:

    1. Find the existing Task block that calls `HookInstallerManager.shared.refreshStatus()`

    2. Replace/extend it to also install library and session start hook:
       ```swift
       // Install/update external files and refresh hook status
       Task {
           // Install library if needed (non-blocking)
           await HookInstallerManager.shared.installLibraryIfNeeded()

           // Install session start hook if needed (non-blocking)
           await HookInstallerManager.shared.installSessionStartHookIfNeeded()

           // Refresh hook status (existing)
           await HookInstallerManager.shared.refreshStatus()
       }
       ```

    3. Add a log line for external files installation:
       `logInfo("Installing/updating external files...", category: .hooks)` before the calls

    Order matters: Install library FIRST (session-start hook sources it), then hook, then refresh status.

    Keep Task block non-blocking - errors are logged inside HookInstallerManager methods but don't propagate.
  </action>
  <verify>
    1. Build and run app: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build && open /path/to/Dispatch.app`
    2. Check files exist:
       - `ls -la ~/.claude/lib/dispatch.sh` - should exist with 755 permissions
       - `ls -la ~/.claude/hooks/session-start.sh` - should exist with 755 permissions
    3. Check log output shows installation messages
  </verify>
  <done>
    - setupApp() calls installLibraryIfNeeded() on launch
    - setupApp() calls installSessionStartHookIfNeeded() on launch
    - Installation happens before refreshStatus()
    - Logs show installation activity on app launch
    - Both files exist at expected paths after launching app
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Fresh install test:**
   - Delete `~/.claude/lib/dispatch.sh` and `~/.claude/hooks/session-start.sh`
   - Launch Dispatch
   - Verify both files are created with correct permissions (755)
   - Verify dispatch.sh contains DISPATCH_LIB_VERSION matching app version

2. **Version upgrade test:**
   - Edit ~/.claude/lib/dispatch.sh to have DISPATCH_LIB_VERSION="0.9.0"
   - Relaunch Dispatch
   - Verify file is updated to current version

3. **No overwrite test for session-start:**
   - Create ~/.claude/hooks/session-start.sh with different content (no marker)
   - Relaunch Dispatch
   - Verify file is NOT overwritten (user's custom hook preserved)

4. **Build verification:**
   - `xcodebuild -scheme Dispatch -destination 'platform=macOS' build` succeeds
   - No warnings related to resource bundling
</verification>

<success_criteria>
- APP-01 satisfied: Library auto-installed to ~/.claude/lib/dispatch.sh
- APP-02 satisfied: Library updated when app version differs from installed version
- APP-03 satisfied: SessionStart hook auto-installed to ~/.claude/hooks/session-start.sh
- All files have executable permissions (0o755)
- Installation is non-blocking (errors logged, app continues)
- Resources bundled in app and accessible via Bundle.main
</success_criteria>

<output>
After completion, create `.planning/phases/10-dispatch-app-updates/10-01-SUMMARY.md`
</output>
