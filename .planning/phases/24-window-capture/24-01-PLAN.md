---
phase: 24-window-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dispatch/Services/ScreenshotCaptureService.swift
  - Dispatch/DispatchApp.swift
autonomous: true

must_haves:
  truths:
    - "User clicks 'Capture Window' and sees system SCContentSharingPicker"
    - "User can select any window to capture (not just Dispatch)"
    - "iOS Simulator windows appear prominently (Dispatch excluded from picker)"
    - "Captured window image saves to QuickCaptures directory as PNG"
    - "User can cancel window capture without errors"
  artifacts:
    - path: "Dispatch/Services/ScreenshotCaptureService.swift"
      provides: "captureWindow() method with SCContentSharingPicker integration"
      contains: "SCContentSharingPickerObserver"
    - path: "Dispatch/DispatchApp.swift"
      provides: "Capture Window menu item"
      contains: "Capture Window"
  key_links:
    - from: "Dispatch/DispatchApp.swift"
      to: "ScreenshotCaptureService.shared.captureWindow()"
      via: "Menu button action"
      pattern: "captureWindow\\(\\)"
    - from: "ScreenshotCaptureService"
      to: "SCContentSharingPicker"
      via: "Observer pattern with continuation"
      pattern: "SCContentSharingPickerObserver"
---

<objective>
Add window capture functionality using macOS SCContentSharingPicker for user-driven window selection.

Purpose: Enable users to capture entire windows without custom UI or Screen Recording permission. The system picker handles authorization through user interaction. Excluding Dispatch from the picker makes Simulator windows more prominent.

Output: Working window capture via menu item, saving PNG to QuickCaptures directory.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-window-capture/24-RESEARCH.md
@.planning/phases/23-region-capture/23-01-SUMMARY.md
@Dispatch/Services/ScreenshotCaptureService.swift
@Dispatch/DispatchApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add window capture to ScreenshotCaptureService</name>
  <files>Dispatch/Services/ScreenshotCaptureService.swift</files>
  <action>
Extend ScreenshotCaptureService to add window capture using SCContentSharingPicker:

1. Add import: `import ScreenCaptureKit`

2. Add CaptureError enum (for PNG conversion failures):
```swift
enum CaptureError: Error {
    case pngConversionFailed
    case captureDirectoryCreationFailed
}
```

3. Make class conform to `SCContentSharingPickerObserver`:
```swift
@MainActor
final class ScreenshotCaptureService: SCContentSharingPickerObserver {
```

4. Add properties for picker and continuation:
```swift
private let picker = SCContentSharingPicker.shared
private var windowCaptureContination: CheckedContinuation<CaptureResult, Never>?
```

5. Add `captureWindow()` async method:
- Use withCheckedContinuation to bridge callback to async/await
- Store continuation in property
- Add self as observer to picker
- Set picker.isActive = true
- Configure picker: excludedBundleIDs = ["com.Eric.Dispatch"], allowsRepicking = true
- Call picker.present(using: .window)
- Log debug info

6. Implement SCContentSharingPickerObserver methods (all nonisolated):

a) `contentSharingPicker(_:didUpdateWith:for:)`:
   - Task { @MainActor } to call captureWithFilter
   - Resume continuation with result
   - Set continuation to nil
   - Remove self from picker

b) `contentSharingPickerStartDidFailWithError(_:)`:
   - Task { @MainActor } to resume with .error
   - Set continuation to nil

c) `contentSharingPicker(_:didCancelFor:)`:
   - Task { @MainActor } to resume with .cancelled
   - Set continuation to nil
   - Remove self from picker

7. Add private `captureWithFilter(_ filter: SCContentFilter) async throws -> URL`:
- Ensure captures directory exists
- Configure SCStreamConfiguration:
  - showsCursor = false
  - width = Int(Float(filter.contentRect.width) * filter.pointPixelScale)
  - height = Int(Float(filter.contentRect.height) * filter.pointPixelScale)
- Call SCScreenshotManager.captureImage(contentFilter:configuration:)
- Generate UUID filename
- Call saveCGImageAsPNG helper
- Log success
- Return URL

8. Add private `saveCGImageAsPNG(_ cgImage: CGImage, to url: URL) throws`:
- Create NSBitmapImageRep from CGImage
- Get PNG representation
- Write to URL
- Throw CaptureError.pngConversionFailed if conversion fails

Add comprehensive logging at each step using .capture category.
  </action>
  <verify>
Build: `xcodebuild -project Dispatch.xcodeproj -scheme Dispatch -configuration Debug build 2>&1 | tail -20`
Expect: BUILD SUCCEEDED with no errors
  </verify>
  <done>
ScreenshotCaptureService has captureWindow() method that presents SCContentSharingPicker, captures selected window as CGImage, and saves to QuickCaptures as PNG. Dispatch app excluded from picker list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add window capture menu item</name>
  <files>Dispatch/DispatchApp.swift</files>
  <action>
Add "Capture Window" button to the existing Capture menu:

1. In the CommandMenu("Capture") section, after the "Capture Region" button, add:

```swift
Button("Capture Window") {
    Task {
        let result = await ScreenshotCaptureService.shared.captureWindow()
        switch result {
        case let .success(url):
            logInfo("Window captured: \(url.lastPathComponent)", category: .capture)
        case .cancelled:
            logInfo("Window capture cancelled", category: .capture)
        case let .error(error):
            logError("Window capture failed: \(error)", category: .capture)
        }
    }
}
.keyboardShortcut("7", modifiers: [.command, .shift])
```

Use Cmd+Shift+7 (following Cmd+Shift+6 for region).
  </action>
  <verify>
1. Build and run app
2. Click Capture menu - should show both "Capture Region" and "Capture Window"
3. Click "Capture Window" - system picker should appear
4. Select a window - should save PNG to ~/Library/Application Support/Dispatch/QuickCaptures/
5. Press Escape - should cancel gracefully with no errors
  </verify>
  <done>
Capture menu shows "Capture Window" (Cmd+Shift+7). Clicking presents system picker. Selecting window saves PNG to QuickCaptures. Cancelling logs cancellation.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with no errors
2. Capture menu contains both Region and Window options
3. Window capture presents SCContentSharingPicker (system UI)
4. Dispatch app is NOT shown in picker list (excluded)
5. Selecting any window saves PNG to QuickCaptures directory
6. Cancelling capture (Escape or click away) handles gracefully
7. Console logs show capture lifecycle
</verification>

<success_criteria>
- SCContentSharingPicker presents when clicking "Capture Window"
- User can select any window except Dispatch
- Selected window is captured and saved as PNG
- Cancellation handled gracefully (no errors, proper logging)
- Keyboard shortcut Cmd+Shift+7 works
</success_criteria>

<output>
After completion, create `.planning/phases/24-window-capture/24-01-SUMMARY.md`
</output>
