---
phase: 25-annotation-integration
plan: 02
type: execute
wave: 2
depends_on: ["25-01"]
files_modified:
  - Dispatch/Views/QuickCapture/SessionPickerView.swift
  - Dispatch/Views/QuickCapture/QuickCaptureAnnotationView.swift
autonomous: true

must_haves:
  truths:
    - "User can select target Claude session before dispatching"
    - "Dispatched screenshot goes to selected session, not hardcoded default"
    - "Active session is auto-selected as default"
  artifacts:
    - path: "Dispatch/Views/QuickCapture/SessionPickerView.swift"
      provides: "Session selection dropdown"
      min_lines: 50
    - path: "Dispatch/Views/QuickCapture/QuickCaptureAnnotationView.swift"
      provides: "Integrated dispatch with session selection"
      contains: "selectedSessionId"
  key_links:
    - from: "QuickCaptureAnnotationView dispatch"
      to: "EmbeddedTerminalService.dispatchPrompt(_:to:)"
      via: "selectedSessionId parameter"
      pattern: "dispatchPrompt.*to.*sessionId"
    - from: "SessionPickerView"
      to: "TerminalSessionManager.sessions"
      via: "ObservedObject binding"
      pattern: "TerminalSessionManager.shared"
---

<objective>
Add session selection to annotation UI for targeted dispatch.

Purpose: Users with multiple Claude Code sessions need to select which session receives the annotated screenshot. The active session should be pre-selected for convenience.

Output:
- SessionPickerView component showing available sessions
- QuickCaptureAnnotationView with session picker integrated
- Dispatch logic using selected session (not hardcoded)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-annotation-integration/25-RESEARCH.md
@Dispatch/Views/QuickCapture/QuickCaptureAnnotationView.swift
@Dispatch/Services/TerminalSessionManager.swift
@Dispatch/Services/EmbeddedTerminalService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionPickerView Component</name>
  <files>
    Dispatch/Views/QuickCapture/SessionPickerView.swift
  </files>
  <action>
Create SessionPickerView following RESEARCH.md patterns:

Create `Dispatch/Views/QuickCapture/SessionPickerView.swift`:
```swift
import SwiftUI

/// Dropdown picker for selecting target Claude Code session.
/// Shows only active sessions with available terminals.
struct SessionPickerView: View {
    @Binding var selectedSessionId: UUID?

    // Use direct observation of TerminalSessionManager
    private var sessionManager: TerminalSessionManager { TerminalSessionManager.shared }

    /// Filter to only sessions with active terminals
    private var availableSessions: [TerminalSession] {
        sessionManager.sessions.filter { session in
            sessionManager.terminal(for: session.id) != nil
        }
    }

    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            Label("Target Session", systemImage: "terminal")
                .font(.caption)
                .foregroundStyle(.secondary)

            Picker("", selection: $selectedSessionId) {
                Text("Select Claude Code session...")
                    .tag(nil as UUID?)

                if availableSessions.isEmpty {
                    Text("No sessions available")
                        .foregroundStyle(.secondary)
                        .tag(nil as UUID?)
                } else {
                    ForEach(availableSessions) { session in
                        sessionLabel(for: session)
                            .tag(session.id as UUID?)
                    }
                }
            }
            .pickerStyle(.menu)
            .disabled(availableSessions.isEmpty)

            // Status indicator
            if let selectedId = selectedSessionId,
               let session = sessionManager.sessions.first(where: { $0.id == selectedId }) {
                HStack(spacing: 4) {
                    Image(systemName: "checkmark.circle.fill")
                        .foregroundStyle(.green)
                    Text("Ready: \(session.name)")
                }
                .font(.caption2)
                .foregroundStyle(.secondary)
            } else if availableSessions.isEmpty {
                HStack(spacing: 4) {
                    Image(systemName: "exclamationmark.triangle.fill")
                        .foregroundStyle(.orange)
                    Text("No terminal sessions open")
                }
                .font(.caption2)
                .foregroundStyle(.secondary)
            }
        }
    }

    @ViewBuilder
    private func sessionLabel(for session: TerminalSession) -> some View {
        HStack {
            Text(session.name)
            Spacer()

            // Claude session indicator
            if session.claudeSessionId != nil {
                Image(systemName: "sparkles")
                    .foregroundStyle(.blue)
                    .help("Claude Code session")
            }

            // Active session indicator
            if session.id == sessionManager.activeSessionId {
                Image(systemName: "circle.fill")
                    .foregroundStyle(.green)
                    .font(.system(size: 6))
                    .help("Active session")
            }
        }
    }
}
```

Note: Use @Observable pattern from TerminalSessionManager. The view will react to session changes automatically.
  </action>
  <verify>
Project builds: `xcodebuild -scheme Dispatch build`
  </verify>
  <done>
SessionPickerView component exists with session filtering and status indicators.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Session Picker and Complete Dispatch</name>
  <files>
    Dispatch/Views/QuickCapture/QuickCaptureAnnotationView.swift
  </files>
  <action>
Update QuickCaptureAnnotationView to integrate session picker and implement dispatch:

1. Add state for selected session:
```swift
@State private var selectedSessionId: UUID?
```

2. Replace placeholder session picker with real one in rightPanel:
```swift
// Replace the placeholder Text with:
SessionPickerView(selectedSessionId: $selectedSessionId)
    .padding(.horizontal)
```

3. Auto-select active session on appear:
```swift
.onAppear {
    loadCapture()
    // Auto-select active session
    selectedSessionId = TerminalSessionManager.shared.activeSessionId
}
```

4. Update canDispatch computed property:
```swift
private var canDispatch: Bool {
    annotationVM.hasQueuedImages &&
    !annotationVM.promptText.isEmpty &&
    selectedSessionId != nil
}
```

5. Enable dispatch button:
```swift
private var dispatchButton: some View {
    Button {
        Task { await dispatch() }
    } label: {
        HStack(spacing: 6) {
            Image(systemName: "paperplane.fill")
            Text("Dispatch to Session")
        }
        .frame(maxWidth: .infinity)
        .padding(.vertical, 8)
    }
    .buttonStyle(.borderedProminent)
    .disabled(!canDispatch)
    .keyboardShortcut(.return, modifiers: .command)
}
```

6. Implement dispatch method:
```swift
private func dispatch() async {
    guard let sessionId = selectedSessionId else {
        errorMessage = "Please select a target Claude Code session"
        showingError = true
        return
    }

    // Copy images to clipboard
    let success = await annotationVM.copyToClipboard()

    guard success else {
        errorMessage = "Failed to copy images to clipboard"
        showingError = true
        return
    }

    // Dispatch to selected session
    let dispatched = EmbeddedTerminalService.shared.dispatchPrompt(
        annotationVM.promptText,
        to: sessionId
    )

    guard dispatched else {
        errorMessage = "Failed to dispatch to session. Session may have closed."
        showingError = true
        return
    }

    // Clear state on success
    annotationVM.handleDispatchComplete()

    logInfo("Dispatched \(annotationVM.queueCount) images to session \(sessionId)", category: .capture)

    // Close window after successful dispatch
    dismiss()
}
```

7. Remove the placeholder text about session selection.
  </action>
  <verify>
1. Build succeeds: `xcodebuild -scheme Dispatch build`
2. Launch app, open a terminal session
3. Capture screenshot (Cmd+Shift+6)
4. Session picker shows available sessions
5. Active session is pre-selected
6. Can change session selection
7. Add annotation, write prompt
8. Cmd+Enter dispatches to selected session
9. Images are in clipboard, prompt appears in terminal
  </verify>
  <done>
SessionPickerView integrated into QuickCaptureAnnotationView.
Active session auto-selected as default.
Dispatch sends to selected session (not hardcoded).
Window closes after successful dispatch.
  </done>
</task>

</tasks>

<verification>
1. Build verification: `xcodebuild -scheme Dispatch build` succeeds
2. Session picker shows only sessions with active terminals
3. Active session is auto-selected when annotation window opens
4. User can change selection to different session
5. Dispatch button enabled only when: has queued images + has prompt + has selected session
6. Successful dispatch: images copied to clipboard, prompt sent to selected session
7. Window closes after successful dispatch
8. Error shown if session becomes unavailable
</verification>

<success_criteria>
- SessionPickerView component reusable
- Session picker integrated into QuickCaptureAnnotationView
- Active session pre-selected for convenience
- Dispatch uses selected session (ANNOT-03 requirement)
- Proper error handling for unavailable sessions
- Window closes after successful dispatch
</success_criteria>

<output>
After completion, create `.planning/phases/25-annotation-integration/25-02-SUMMARY.md`
</output>
