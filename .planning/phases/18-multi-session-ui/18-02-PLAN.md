---
phase: 18-multi-session-ui
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - Dispatch/Views/Terminal/MultiSessionTerminalView.swift
  - Dispatch/Views/Terminal/SessionTabBar.swift
  - Dispatch/Views/Terminal/SessionPaneView.swift
  - Dispatch/Views/MainView.swift
autonomous: true

must_haves:
  truths:
    - "User can create new terminal sessions via button"
    - "Sessions display in a tab bar for switching"
    - "User can view 2 sessions simultaneously in split pane"
    - "Clicking a session pane makes it the active dispatch target"
    - "User can toggle between focus mode and split mode"
  artifacts:
    - path: "Dispatch/Views/Terminal/MultiSessionTerminalView.swift"
      provides: "Container view with splits and session list"
      exports: ["MultiSessionTerminalView"]
    - path: "Dispatch/Views/Terminal/SessionTabBar.swift"
      provides: "Tab bar for session switching"
      exports: ["SessionTabBar"]
    - path: "Dispatch/Views/Terminal/SessionPaneView.swift"
      provides: "Individual session pane wrapper"
      exports: ["SessionPaneView"]
    - path: "Dispatch/Views/MainView.swift"
      provides: "Integration with multi-session terminal"
      contains: "MultiSessionTerminalView"
  key_links:
    - from: "SessionTabBar"
      to: "TerminalSessionManager.createSession"
      via: "plus button action"
      pattern: "createSession\\(\\)"
    - from: "SessionPaneView"
      to: "TerminalSessionManager.setActiveSession"
      via: "tap gesture"
      pattern: "setActiveSession"
    - from: "MainView"
      to: "MultiSessionTerminalView"
      via: "HSplitView child"
      pattern: "MultiSessionTerminalView"
---

<objective>
Build multi-session UI with tab bar, split panes, and focus mode.

Purpose: Enable users to create, switch, and view multiple terminal sessions simultaneously. This completes the multi-session UX as specified in requirements SESS-01 through SESS-05.

Output: MultiSessionTerminalView container, SessionTabBar for session list, SessionPaneView for individual panes, MainView integration replacing single EmbeddedTerminalView.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-multi-session-ui/18-RESEARCH.md
@.planning/phases/18-multi-session-ui/18-01-SUMMARY.md

@Dispatch/Views/MainView.swift
@Dispatch/Views/Terminal/EmbeddedTerminalView.swift
@Dispatch/Models/TerminalSession.swift
@Dispatch/Services/TerminalSessionManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SessionPaneView wrapper</name>
  <files>Dispatch/Views/Terminal/SessionPaneView.swift</files>
  <action>
Create SessionPaneView.swift in Dispatch/Views/Terminal/:

```swift
//
//  SessionPaneView.swift
//  Dispatch
//
//  Wrapper view for individual terminal session with header and focus indicator
//

import SwiftUI

struct SessionPaneView: View {
    let session: TerminalSession

    @State private var sessionManager = TerminalSessionManager.shared

    private var isActive: Bool {
        sessionManager.activeSessionId == session.id
    }

    var body: some View {
        VStack(spacing: 0) {
            // Session header
            HStack(spacing: 8) {
                // Active indicator
                Circle()
                    .fill(isActive ? Color.accentColor : Color.clear)
                    .frame(width: 8, height: 8)

                Text(session.name)
                    .font(.caption)
                    .fontWeight(isActive ? .semibold : .regular)
                    .foregroundStyle(isActive ? .primary : .secondary)
                    .lineLimit(1)

                Spacer()

                // Close button
                Button {
                    sessionManager.closeSession(session.id)
                } label: {
                    Image(systemName: "xmark")
                        .font(.caption2)
                        .foregroundStyle(.secondary)
                }
                .buttonStyle(.plain)
                .opacity(0.7)
                .help("Close session")
            }
            .padding(.horizontal, 8)
            .padding(.vertical, 4)
            .background(isActive ? Color.accentColor.opacity(0.1) : Color(nsColor: .controlBackgroundColor))

            Divider()

            // Terminal view with session ID
            EmbeddedTerminalView(
                sessionId: session.id,
                launchMode: .claudeCode(workingDirectory: nil, skipPermissions: true)
            )
        }
        .clipShape(RoundedRectangle(cornerRadius: 6))
        .overlay(
            RoundedRectangle(cornerRadius: 6)
                .stroke(isActive ? Color.accentColor : Color.gray.opacity(0.3), lineWidth: isActive ? 2 : 1)
        )
        .contentShape(Rectangle())
        .onTapGesture {
            // SESS-04: Clicking makes session active for prompt dispatch
            sessionManager.setActiveSession(session.id)
        }
    }
}

#Preview {
    SessionPaneView(session: TerminalSession(name: "Test Session"))
        .frame(width: 400, height: 300)
}
```

Key design decisions:
- Header shows session name with active indicator (dot)
- Close button always visible (not just on hover - simpler)
- Blue border highlight indicates active session
- onTapGesture sets active session for dispatch targeting
- Uses @State with singleton pattern for TerminalSessionManager
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | grep -E "(error:|Build Succeeded)"`
  </verify>
  <done>
SessionPaneView exists with session header, close button, and focus indicator.
Tapping pane calls setActiveSession.
EmbeddedTerminalView receives session.id.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SessionTabBar and MultiSessionTerminalView</name>
  <files>
    Dispatch/Views/Terminal/SessionTabBar.swift
    Dispatch/Views/Terminal/MultiSessionTerminalView.swift
  </files>
  <action>
Create SessionTabBar.swift in Dispatch/Views/Terminal/:

```swift
//
//  SessionTabBar.swift
//  Dispatch
//
//  Tab bar showing all sessions with new session button
//

import SwiftUI

struct SessionTabBar: View {
    @State private var sessionManager = TerminalSessionManager.shared

    var body: some View {
        HStack(spacing: 0) {
            // Session tabs
            ForEach(sessionManager.sessions) { session in
                SessionTabButton(session: session)
            }

            Spacer()

            // Session count indicator
            if sessionManager.sessions.count > 0 {
                Text("\(sessionManager.sessions.count)/\(sessionManager.maxSessions)")
                    .font(.caption2)
                    .foregroundStyle(.tertiary)
                    .padding(.trailing, 8)
            }

            // New session button
            Button {
                _ = sessionManager.createSession()
            } label: {
                Image(systemName: "plus")
                    .font(.caption)
            }
            .buttonStyle(.plain)
            .padding(.horizontal, 8)
            .padding(.vertical, 6)
            .disabled(!sessionManager.canCreateSession)
            .help(sessionManager.canCreateSession ? "New session (Cmd+T)" : "Maximum sessions reached")
        }
        .frame(height: 28)
        .background(Color(nsColor: .controlBackgroundColor))
    }
}

struct SessionTabButton: View {
    let session: TerminalSession

    @State private var sessionManager = TerminalSessionManager.shared
    @State private var isHovering = false

    private var isActive: Bool {
        sessionManager.activeSessionId == session.id
    }

    var body: some View {
        Button {
            sessionManager.setActiveSession(session.id)
        } label: {
            HStack(spacing: 4) {
                Text(session.name)
                    .font(.caption)
                    .lineLimit(1)

                // Close button (visible on hover or active)
                if isHovering || isActive {
                    Button {
                        sessionManager.closeSession(session.id)
                    } label: {
                        Image(systemName: "xmark")
                            .font(.system(size: 8, weight: .semibold))
                    }
                    .buttonStyle(.plain)
                }
            }
            .padding(.horizontal, 10)
            .padding(.vertical, 6)
        }
        .buttonStyle(.plain)
        .background(isActive ? Color.accentColor.opacity(0.15) : Color.clear)
        .onHover { hovering in
            isHovering = hovering
        }
    }
}

#Preview {
    SessionTabBar()
        .frame(width: 500)
}
```

Create MultiSessionTerminalView.swift in Dispatch/Views/Terminal/:

```swift
//
//  MultiSessionTerminalView.swift
//  Dispatch
//
//  Container view managing multiple terminal sessions with split layout
//

import SwiftUI

struct MultiSessionTerminalView: View {
    @State private var sessionManager = TerminalSessionManager.shared

    var body: some View {
        VStack(spacing: 0) {
            // Tab bar at top
            SessionTabBar()

            Divider()

            // Terminal panes
            Group {
                if sessionManager.sessions.isEmpty {
                    // Empty state - prompt to create session
                    emptyState
                } else {
                    switch sessionManager.layoutMode {
                    case .single:
                        // Focus mode: show only active session
                        focusModeContent

                    case .horizontalSplit:
                        // Side-by-side split
                        horizontalSplitContent

                    case .verticalSplit:
                        // Above-and-below split
                        verticalSplitContent
                    }
                }
            }
            .animation(.easeInOut(duration: 0.2), value: sessionManager.layoutMode)
        }
        .toolbar {
            ToolbarItemGroup(placement: .automatic) {
                // Layout mode picker
                if sessionManager.sessions.count >= 2 {
                    Picker("Layout", selection: Binding(
                        get: { sessionManager.layoutMode },
                        set: { sessionManager.setLayoutMode($0) }
                    )) {
                        Image(systemName: "rectangle")
                            .tag(TerminalSessionManager.LayoutMode.single)
                        Image(systemName: "rectangle.split.2x1")
                            .tag(TerminalSessionManager.LayoutMode.horizontalSplit)
                        Image(systemName: "rectangle.split.1x2")
                            .tag(TerminalSessionManager.LayoutMode.verticalSplit)
                    }
                    .pickerStyle(.segmented)
                    .help("Layout mode")
                }
            }
        }
        .onAppear {
            // Create initial session if none exist
            if sessionManager.sessions.isEmpty {
                _ = sessionManager.createSession(name: "Session 1")
            }
        }
    }

    // MARK: - Empty State

    @ViewBuilder
    private var emptyState: some View {
        ContentUnavailableView {
            Label("No Sessions", systemImage: "terminal")
        } description: {
            Text("Create a new terminal session to get started")
        } actions: {
            Button("New Session") {
                _ = sessionManager.createSession()
            }
        }
    }

    // MARK: - Focus Mode

    @ViewBuilder
    private var focusModeContent: some View {
        if let activeSession = sessionManager.activeSession {
            SessionPaneView(session: activeSession)
                .id(activeSession.id)
                .padding(4)
        } else if let firstSession = sessionManager.sessions.first {
            SessionPaneView(session: firstSession)
                .id(firstSession.id)
                .padding(4)
        }
    }

    // MARK: - Horizontal Split (Side-by-Side)

    @ViewBuilder
    private var horizontalSplitContent: some View {
        let visibleSessions = Array(sessionManager.sessions.prefix(2))

        HSplitView {
            ForEach(visibleSessions) { session in
                SessionPaneView(session: session)
                    .id(session.id)
                    .frame(minWidth: 300)
            }
        }
        .padding(4)
    }

    // MARK: - Vertical Split (Above-and-Below)

    @ViewBuilder
    private var verticalSplitContent: some View {
        let visibleSessions = Array(sessionManager.sessions.prefix(2))

        VSplitView {
            ForEach(visibleSessions) { session in
                SessionPaneView(session: session)
                    .id(session.id)
                    .frame(minHeight: 150)
            }
        }
        .padding(4)
    }
}

#Preview {
    MultiSessionTerminalView()
        .frame(width: 800, height: 600)
}
```

Key design decisions:
- Tab bar always visible at top for quick session switching
- Layout mode picker in toolbar (only shows with 2+ sessions)
- Empty state prompts user to create first session
- onAppear creates initial session automatically
- .id(session.id) ensures stable view identity
- Horizontal/vertical splits show first 2 sessions only
- Padding around panes for visual separation
  </action>
  <verify>
Build succeeds. Both files exist in Dispatch/Views/Terminal/.
  </verify>
  <done>
SessionTabBar displays session tabs with close buttons and new session button.
MultiSessionTerminalView switches between focus/horizontal/vertical layouts.
Layout mode picker shows when 2+ sessions exist.
Auto-creates first session on appear.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate MultiSessionTerminalView into MainView</name>
  <files>Dispatch/Views/MainView.swift</files>
  <action>
Modify MainView.swift to use MultiSessionTerminalView instead of single EmbeddedTerminalView:

1. Replace `EmbeddedTerminalView(...)` with `MultiSessionTerminalView()`
2. Add keyboard shortcut Cmd+T for new session
3. Keep existing Cmd+Shift+T for terminal toggle
4. Add environment for TerminalSessionManager

Changes to make:

```swift
// In MainView body, replace the terminal HSplitView section:

// OLD (around line 94-107):
if showTerminal {
    HSplitView {
        contentWrapper
            .frame(minWidth: 400)

        // Terminal panel
        EmbeddedTerminalView(launchMode: .claudeCode(workingDirectory: nil, skipPermissions: true))
            .frame(minWidth: 400)
    }
    .frame(maxHeight: .infinity)
} else {
    contentWrapper
        .frame(maxHeight: .infinity)
}

// NEW:
if showTerminal {
    HSplitView {
        contentWrapper
            .frame(minWidth: 400)

        // Multi-session terminal panel
        MultiSessionTerminalView()
            .frame(minWidth: 400)
    }
    .frame(maxHeight: .infinity)
} else {
    contentWrapper
        .frame(maxHeight: .infinity)
}
```

Add new session keyboard shortcut to toolbar:

```swift
// In toolbarContent, add after terminal toggle button:

// New session shortcut (only when terminal visible)
if showTerminal {
    Button {
        _ = TerminalSessionManager.shared.createSession()
    } label: {
        Label("New Session", systemImage: "plus.rectangle")
    }
    .keyboardShortcut("t", modifiers: .command)
    .disabled(!TerminalSessionManager.shared.canCreateSession)
}
```

Note: The existing Cmd+Shift+T toggle remains unchanged. Cmd+T (without shift) creates new session when terminal is visible.
  </action>
  <verify>
1. Build succeeds
2. Run app, toggle terminal (Cmd+Shift+T)
3. Multi-session terminal appears with tab bar
4. Create new session (Cmd+T or plus button)
5. Switch between sessions via tabs
6. Layout picker appears with 2+ sessions
7. Split layouts work correctly
  </verify>
  <done>
MainView uses MultiSessionTerminalView instead of single EmbeddedTerminalView.
Cmd+T creates new session when terminal visible.
Tab bar displays for session switching.
Layout mode picker works with 2+ sessions.
  </done>
</task>

</tasks>

<verification>
1. Build verification:
   ```bash
   xcodebuild -scheme Dispatch -destination 'platform=macOS' build 2>&1 | tail -5
   ```

2. Functional verification (run app):
   - Toggle terminal (Cmd+Shift+T): MultiSessionTerminalView appears
   - First session auto-created with "Session 1" name
   - Click plus button or Cmd+T: New session created (up to 4)
   - Click session tab: Switches active session
   - Click session pane: Makes it active (blue highlight)
   - Close button on tab/pane: Closes session
   - Layout picker (with 2+ sessions): Switch between focus/horizontal/vertical

3. Requirements verification:
   - SESS-01: Can create multiple sessions (yes, up to 4)
   - SESS-02: Sessions display in tab bar (yes)
   - SESS-03: Split pane shows 2 sessions (yes, horizontal and vertical)
   - SESS-04: Clicking session makes it active (yes, via tap gesture)
   - SESS-05: Focus mode enlarges to full panel (yes, single layout mode)
   - SESS-06: Max session limit enforced (yes, 4 sessions)
</verification>

<success_criteria>
1. SessionPaneView shows terminal with header and focus indicator
2. SessionTabBar shows all sessions with create button
3. MultiSessionTerminalView supports single/horizontal/vertical layouts
4. MainView replaced single EmbeddedTerminalView with MultiSessionTerminalView
5. Cmd+T creates new session when terminal visible
6. Tab clicks switch active session
7. Pane clicks set active session for dispatch
8. Layout picker works with 2+ sessions
9. All SESS-01 through SESS-06 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/18-multi-session-ui/18-02-SUMMARY.md`
</output>
