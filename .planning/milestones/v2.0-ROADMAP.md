# Milestone v2.0: In-App Claude Code

**Status:** SHIPPED 2026-02-09
**Phases:** 14-22
**Total Plans:** 22

## Overview

Replace Terminal.app dependency with embedded terminal sessions, enabling full Claude Code management within Dispatch.

## Phases

### Phase 14: SwiftTerm Integration

**Goal**: SwiftTerm package integrated and basic terminal view renders a bash shell
**Depends on**: Nothing (first phase of v2.0)
**Requirements**: TERM-01, TERM-02
**Plans**: 1 plan

Plans:
- [x] 14-01-PLAN.md — Add SwiftTerm package and create EmbeddedTerminalView

**Success Criteria:**
1. SwiftTerm package is added to Xcode project and builds successfully
2. EmbeddedTerminalView displays in the Dispatch window with proper sizing
3. User can type commands in the embedded terminal and see output
4. Terminal supports ANSI colors and standard terminal escape sequences

### Phase 15: Safe Terminal Wrapper

**Goal**: Terminal data reception is thread-safe and survives view lifecycle changes
**Depends on**: Phase 14
**Requirements**: TERM-03
**Plans**: 1 plan

Plans:
- [x] 15-01-PLAN.md — Add lifecycle-safe coordinator with deinit cleanup

**Success Criteria:**
1. Rapidly closing and reopening terminal views does not crash the app
2. Terminal continues receiving data during view updates/redraws
3. No EXC_BAD_ACCESS crashes during process termination

### Phase 16: Process Lifecycle

**Goal**: Terminal processes are tracked, persisted, and cleaned up reliably
**Depends on**: Phase 15
**Requirements**: PROC-01, PROC-02, PROC-03, PROC-04, PROC-05
**Plans**: 2 plans

Plans:
- [x] 16-01-PLAN.md — Create TerminalProcessRegistry with PID tracking and persistence
- [x] 16-02-PLAN.md — Implement graceful termination and orphan cleanup

**Success Criteria:**
1. TerminalProcessRegistry tracks all spawned process PIDs
2. Quitting and relaunching Dispatch cleans up any orphaned processes from previous session
3. Closing a terminal session terminates both shell and any child processes (Claude Code)
4. Process termination uses graceful shutdown (SIGTERM first, SIGKILL if needed)

### Phase 17: Claude Code Integration

**Goal**: Claude Code runs in embedded terminal with prompt dispatch and completion detection
**Depends on**: Phase 16
**Requirements**: TERM-04, TERM-05, TERM-06
**Plans**: 4 plans (2 core + 2 gap closure)

Plans:
- [x] 17-01-PLAN.md — Create ClaudeCodeLauncher service with environment configuration
- [x] 17-02-PLAN.md — Implement prompt dispatch via PTY and completion detection
- [x] 17-03-PLAN.md — Wire Claude Code as default terminal launch mode (gap closure)
- [x] 17-04-PLAN.md — Create EmbeddedTerminalBridge for ExecutionManager dispatch (gap closure)

**Success Criteria:**
1. Claude Code process launches in terminal with proper environment (PATH, TERM, COLORTERM)
2. Dispatching a prompt writes it to the PTY and Claude Code receives it
3. Completion is detected via output pattern matching (as backup to HookServer)
4. Terminal shows Claude Code's colored output correctly

### Phase 18: Multi-Session UI

**Goal**: Users can manage multiple simultaneous Claude Code sessions
**Depends on**: Phase 17
**Requirements**: SESS-01, SESS-02, SESS-03, SESS-04, SESS-05, SESS-06
**Plans**: 2 plans

Plans:
- [x] 18-01-PLAN.md — Session management infrastructure (TerminalSession model, TerminalSessionManager, bridge registry)
- [x] 18-02-PLAN.md — Multi-session UI (SessionTabBar, SessionPaneView, MultiSessionTerminalView, MainView integration)

**Success Criteria:**
1. User can create multiple terminal sessions (new session button/shortcut)
2. Sessions display in a tab bar or side panel for easy switching
3. User can view 2+ sessions simultaneously via split pane layout
4. Clicking a session makes it the focused/active target for prompt dispatch
5. User can enlarge a session to full panel size (focus mode)

### Phase 19: Session Persistence

**Goal**: Terminal sessions survive app restarts with context preserved
**Depends on**: Phase 18
**Requirements**: PERS-01, PERS-02, PERS-03, PERS-04, PERS-05
**Plans**: 2 plans

Plans:
- [x] 19-01-PLAN.md — Convert TerminalSession to @Model with Project relationship
- [x] 19-02-PLAN.md — Wire persistence (load on launch, resume picker, stale handling)

**Success Criteria:**
1. Session metadata (project, working directory, last activity) persists in SwiftData
2. Sessions are associated with Projects (project-session relationship)
3. Reopening Dispatch offers to resume previous sessions
4. Resuming a session uses `claude -r <sessionId>` to continue conversation
5. Expired/stale sessions create fresh sessions gracefully

### Phase 20: Service Integration

**Goal**: Embedded terminals work with existing queue and chain execution
**Depends on**: Phase 19
**Requirements**: INTG-01, INTG-02, INTG-03, INTG-04, INTG-05
**Plans**: 2 plans

Plans:
- [x] 20-01-PLAN.md — Create EmbeddedTerminalService with dispatch interface, session validation
- [x] 20-02-PLAN.md — Verify queue and chain integration, human verification checkpoint

**Success Criteria:**
1. EmbeddedTerminalService implements same dispatch interface as TerminalService
2. Queue "Run Next" and "Run All" dispatch prompts to embedded terminal
3. Chain execution dispatches sequence with configured delays
4. ExecutionStateMachine transitions correctly for embedded terminal execution
5. HookServer completion detection works alongside output pattern matching

### Phase 21: Status Display

**Goal**: Rich status display from Claude Code JSONL data
**Depends on**: Phase 20
**Requirements**: TERM-07, TERM-08
**Plans**: 1 plan

Plans:
- [x] 21-01-PLAN.md — Parse JSONL session files and display status/context usage

**Success Criteria:**
1. Session status shows current state (thinking, executing, idle)
2. Context window usage displays as visual indicator
3. Status updates in near real-time as Claude Code progresses

### Phase 22: Migration & Cleanup

**Goal**: Terminal.app dependency fully removed, clean codebase
**Depends on**: Phase 21
**Requirements**: MIGR-01, MIGR-02, MIGR-03, MIGR-04
**Plans**: 7 plans (2 core + 5 gap closure)

Plans:
- [x] 22-01-PLAN.md — Replace TerminalService with embedded-only execution in ExecutionManager
- [x] 22-02-PLAN.md — Remove Terminal.app UI controls and AppleEvents permission
- [x] 22-03-PLAN.md — Migrate PromptViewModel.executePrompt() to ExecutionManager (gap closure)
- [x] 22-04-PLAN.md — Deprecate external Terminal.app skill execution methods (gap closure)
- [x] 22-05-PLAN.md — Migrate simulator image dispatch to embedded terminal (gap closure)
- [x] 22-06-PLAN.md — Remove Terminal.app permission UI from SkillsSidePanel (gap closure)
- [x] 22-07-PLAN.md — Migrate ProjectViewModel.openInTerminal() to embedded terminal (gap closure)

**Success Criteria:**
1. TerminalService AppleScript methods are removed or deprecated
2. MainView shows embedded terminal panel instead of external window controls
3. Terminal.app Automation permission is no longer required
4. QueueItem and Chain execution use embedded sessions exclusively

---

## Milestone Summary

**Key Decisions:**
- SwiftTerm + LocalProcess pattern (proven in AgentHub reference app)
- Multi-session split panes with tab bar navigation
- UUID-based session registry for cross-component lookup
- Dual completion detection (HookServer primary, pattern fallback)
- Full Terminal.app replacement (no hybrid mode)
- Session persistence via SwiftData with 7-day retention
- Deprecate over delete (rollback safety, removal in v3.0)

**Issues Resolved:**
- Terminal.app AppleScript reliability issues
- Window targeting complexity
- External process visibility to users
- Permission prompt friction (Automation permission)

**Issues Deferred:**
- Skill migration (20 skills still use hardcoded `/tmp` paths)
- Status monitoring for new sessions (only starts after claudeSessionId set)

**Technical Debt Incurred:**
- Deprecated code retained (TerminalService, TerminalPickerView, skill execution methods)
- Planned for removal in v3.0

---

*For current project status, see .planning/PROJECT.md*
